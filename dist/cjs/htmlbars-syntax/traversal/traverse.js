exports.__esModule = true;
exports.default = traverse;
exports.normalizeVisitor = normalizeVisitor;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _typesVisitorKeys = require('../types/visitor-keys');

var _typesVisitorKeys2 = _interopRequireDefault(_typesVisitorKeys);

var _errors = require('./errors');

function visitNode(visitor, node) {
  var handler = visitor[node.type] || visitor.All;
  var result = undefined;

  if (handler && handler.enter) {
    result = handler.enter.call(null, node);
  }

  if (result === undefined) {
    var keys = _typesVisitorKeys2.default[node.type];

    for (var i = 0; i < keys.length; i++) {
      visitKey(visitor, handler, node, keys[i]);
    }

    if (handler && handler.exit) {
      result = handler.exit.call(null, node);
    }
  }

  return result;
}

function visitKey(visitor, handler, node, key) {
  var value = node[key];
  if (!value) {
    return;
  }

  var keyHandler = handler && (handler.keys[key] || handler.keys.All);
  var result = undefined;

  if (keyHandler && keyHandler.enter) {
    result = keyHandler.enter.call(null, node, key);
    if (result !== undefined) {
      throw _errors.cannotReplaceOrRemoveInKeyHandlerYet(node, key);
    }
  }

  if (Array.isArray(value)) {
    visitArray(visitor, value);
  } else {
    var _result = visitNode(visitor, value);
    if (_result !== undefined) {
      assignKey(node, key, _result);
    }
  }

  if (keyHandler && keyHandler.exit) {
    result = keyHandler.exit.call(null, node, key);
    if (result !== undefined) {
      throw _errors.cannotReplaceOrRemoveInKeyHandlerYet(node, key);
    }
  }
}

function visitArray(visitor, array) {
  for (var i = 0; i < array.length; i++) {
    var result = visitNode(visitor, array[i]);
    if (result !== undefined) {
      i += spliceArray(array, i, result) - 1;
    }
  }
}

function assignKey(node, key, result) {
  if (result === null) {
    throw _errors.cannotRemoveNode(node[key], node, key);
  } else if (Array.isArray(result)) {
    if (result.length === 1) {
      node[key] = result[0];
    } else {
      if (result.length === 0) {
        throw _errors.cannotRemoveNode(node[key], node, key);
      } else {
        throw _errors.cannotReplaceNode(node[key], node, key);
      }
    }
  } else {
    node[key] = result;
  }
}

function spliceArray(array, index, result) {
  if (result === null) {
    array.splice(index, 1);
    return 0;
  } else if (Array.isArray(result)) {
    array.splice.apply(array, [index, 1].concat(result));
    return result.length;
  } else {
    array.splice(index, 1, result);
    return 1;
  }
}

function traverse(node, visitor) {
  visitNode(normalizeVisitor(visitor), node);
}

function normalizeVisitor(visitor) {
  var normalizedVisitor = {};

  for (var type in visitor) {
    var handler = visitor[type] || visitor.All;
    var normalizedKeys = {};

    if (typeof handler === 'object') {
      var keys = handler.keys;
      if (keys) {
        for (var key in keys) {
          var keyHandler = keys[key];
          if (typeof keyHandler === 'object') {
            normalizedKeys[key] = {
              enter: typeof keyHandler.enter === 'function' ? keyHandler.enter : null,
              exit: typeof keyHandler.exit === 'function' ? keyHandler.exit : null
            };
          } else if (typeof keyHandler === 'function') {
            normalizedKeys[key] = {
              enter: keyHandler,
              exit: null
            };
          }
        }
      }

      normalizedVisitor[type] = {
        enter: typeof handler.enter === 'function' ? handler.enter : null,
        exit: typeof handler.exit === 'function' ? handler.exit : null,
        keys: normalizedKeys
      };
    } else if (typeof handler === 'function') {
      normalizedVisitor[type] = {
        enter: handler,
        exit: null,
        keys: normalizedKeys
      };
    }
  }

  return normalizedVisitor;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLXN5bnRheC90cmF2ZXJzYWwvdHJhdmVyc2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtrQkFxR3dCLFFBQVE7UUFJaEIsZ0JBQWdCLEdBQWhCLGdCQUFnQjs7OztnQ0F6R1IsdUJBQXVCOzs7O3NCQUt4QyxVQUFVOztBQUVqQixTQUFTLFNBQVMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFO0FBQ2hDLE1BQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQztBQUNoRCxNQUFJLE1BQU0sWUFBQSxDQUFDOztBQUVYLE1BQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxLQUFLLEVBQUU7QUFDNUIsVUFBTSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztHQUN6Qzs7QUFFRCxNQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUU7QUFDeEIsUUFBSSxJQUFJLEdBQUcsMkJBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOztBQUVsQyxTQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNwQyxjQUFRLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDM0M7O0FBRUQsUUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksRUFBRTtBQUMzQixZQUFNLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3hDO0dBQ0Y7O0FBRUQsU0FBTyxNQUFNLENBQUM7Q0FDZjs7QUFFRCxTQUFTLFFBQVEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUU7QUFDN0MsTUFBSSxLQUFLLEdBQUcs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QUFDM0IsY0FBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUU7QUFDbEMsMEJBQWMsQ0FBQyxHQUFHLENBQUMsR0FBRztBQUNwQixtQkFBSyxFQUFFLEFBQUMsT0FBTyxVQUFVLENBQUMsS0FBSyxLQUFLLFVBQVUsR0FBSSxVQUFVLENBQUMsS0FBSyxHQUFHLElBQUk7QUFDekUsa0JBQUksRUFBRSxBQUFDLE9BQU8sVUFBVSxDQUFDLElBQUksS0FBSyxVQUFVLEdBQUksVUFBVSxDQUFDLElBQUksR0FBRyxJQUFJO2FBQ3ZFLENBQUM7V0FDSCxNQUFNLElBQUksT0FBTyxVQUFVLEtBQUssVUFBVSxFQUFFO0FBQzNDLDBCQUFjLENBQUMsR0FBRyxDQUFDLEdBQUc7QUFDcEIsbUJBQUssRUFBRSxVQUFVO0FBQ2pCLGtCQUFJLEVBQUUsSUFBSTthQUNYLENBQUM7V0FDSDtTQUNGO09BQ0Y7O0FBRUQsdUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUc7QUFDeEIsYUFBSyxFQUFFLEFBQUMsT0FBTyxPQUFPLENBQUMsS0FBSyxLQUFLLFVBQVUsR0FBSSxPQUFPLENBQUMsS0FBSyxHQUFHLElBQUk7QUFDbkUsWUFBSSxFQUFFLEFBQUMsT0FBTyxPQUFPLENBQUMsSUFBSSxLQUFLLFVBQVUsR0FBSSxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUk7QUFDaEUsWUFBSSxFQUFFLGNBQWM7T0FDckIsQ0FBQztLQUNILE1BQU0sSUFBSSxPQUFPLE9BQU8sS0FBSyxVQUFVLEVBQUU7QUFDeEMsdUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUc7QUFDeEIsYUFBSyxFQUFFLE9BQU87QUFDZCxZQUFJLEVBQUUsSUFBSTtBQUNWLFlBQUksRUFBRSxjQUFjO09BQ3JCLENBQUM7S0FDSDtHQUNGOztBQUVELFNBQU8saUJBQWlCLENBQUM7Q0FDMUIiLCJmaWxlIjoiaHRtbGJhcnMtc3ludGF4L3RyYXZlcnNhbC90cmF2ZXJzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB2aXNpdG9yS2V5cyBmcm9tICcuLi90eXBlcy92aXNpdG9yLWtleXMnO1xuaW1wb3J0IHtcbiAgY2Fubm90UmVtb3ZlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldFxufSBmcm9tICcuL2Vycm9ycyc7XG5cbmZ1bmN0aW9uIHZpc2l0Tm9kZSh2aXNpdG9yLCBub2RlKSB7XG4gIGxldCBoYW5kbGVyID0gdmlzaXRvcltub2RlLnR5cGVdIHx8IHZpc2l0b3IuQWxsO1xuICBsZXQgcmVzdWx0O1xuXG4gIGlmIChoYW5kbGVyICYmIGhhbmRsZXIuZW50ZXIpIHtcbiAgICByZXN1bHQgPSBoYW5kbGVyLmVudGVyLmNhbGwobnVsbCwgbm9kZSk7XG4gIH1cblxuICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5cyA9IHZpc2l0b3JLZXlzW25vZGUudHlwZV07XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIG5vZGUsIGtleXNbaV0pO1xuICAgIH1cblxuICAgIGlmIChoYW5kbGVyICYmIGhhbmRsZXIuZXhpdCkge1xuICAgICAgcmVzdWx0ID0gaGFuZGxlci5leGl0LmNhbGwobnVsbCwgbm9kZSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gdmlzaXRLZXkodmlzaXRvciwgaGFuZGxlciwgbm9kZSwga2V5KSB7XG4gIGxldCB2YWx1ZSA9IG5vZGVba2V5XTtcbiAgaWYgKCF2YWx1ZSkgeyByZXR1cm47IH1cblxuICBsZXQga2V5SGFuZGxlciA9IGhhbmRsZXIgJiYgKGhhbmRsZXIua2V5c1trZXldIHx8IGhhbmRsZXIua2V5cy5BbGwpO1xuICBsZXQgcmVzdWx0O1xuXG4gIGlmIChrZXlIYW5kbGVyICYmIGtleUhhbmRsZXIuZW50ZXIpIHtcbiAgICByZXN1bHQgPSBrZXlIYW5kbGVyLmVudGVyLmNhbGwobnVsbCwgbm9kZSwga2V5KTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgdmFsdWUpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgYXNzaWduS2V5KG5vZGUsIGtleSwgcmVzdWx0KTsgXG4gICAgfVxuICB9XG5cbiAgaWYgKGtleUhhbmRsZXIgJiYga2V5SGFuZGxlci5leGl0KSB7XG4gICAgcmVzdWx0ID0ga2V5SGFuZGxlci5leGl0LmNhbGwobnVsbCwgbm9kZSwga2V5KTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB2aXNpdEFycmF5KHZpc2l0b3IsIGFycmF5KSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgcmVzdWx0ID0gdmlzaXROb2RlKHZpc2l0b3IsIGFycmF5W2ldKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGkgKz0gc3BsaWNlQXJyYXkoYXJyYXksIGksIHJlc3VsdCkgLSAxO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NpZ25LZXkobm9kZSwga2V5LCByZXN1bHQpIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAxKSB7XG4gICAgICBub2RlW2tleV0gPSByZXN1bHRbMF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBub2RlW2tleV0gPSByZXN1bHQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gc3BsaWNlQXJyYXkoYXJyYXksIGluZGV4LCByZXN1bHQpIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgcmV0dXJuIDA7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCAuLi5yZXN1bHQpO1xuICAgIHJldHVybiByZXN1bHQubGVuZ3RoO1xuICB9IGVsc2Uge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgcmVzdWx0KTtcbiAgICByZXR1cm4gMTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB0cmF2ZXJzZShub2RlLCB2aXNpdG9yKSB7XG4gIHZpc2l0Tm9kZShub3JtYWxpemVWaXNpdG9yKHZpc2l0b3IpLCBub2RlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVZpc2l0b3IodmlzaXRvcikge1xuICBsZXQgbm9ybWFsaXplZFZpc2l0b3IgPSB7fTtcblxuICBmb3IgKGxldCB0eXBlIGluIHZpc2l0b3IpIHtcbiAgICBsZXQgaGFuZGxlciA9IHZpc2l0b3JbdHlwZV0gfHwgdmlzaXRvci5BbGw7XG4gICAgbGV0IG5vcm1hbGl6ZWRLZXlzID0ge307XG5cbiAgICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdvYmplY3QnKSB7XG4gICAgICBsZXQga2V5cyA9IGhhbmRsZXIua2V5cztcbiAgICAgIGlmIChrZXlzKSB7XG4gICAgICAgIGZvciAobGV0IGtleSBpbiBrZXlzKSB7XG4gICAgICAgICAgbGV0IGtleUhhbmRsZXIgPSBrZXlzW2tleV07XG4gICAgICAgICAgaWYgKHR5cGVvZiBrZXlIYW5kbGVyID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgbm9ybWFsaXplZEtleXNba2V5XSA9IHtcbiAgICAgICAgICAgICAgZW50ZXI6ICh0eXBlb2Yga2V5SGFuZGxlci5lbnRlciA9PT0gJ2Z1bmN0aW9uJykgPyBrZXlIYW5kbGVyLmVudGVyIDogbnVsbCxcbiAgICAgICAgICAgICAgZXhpdDogKHR5cGVvZiBrZXlIYW5kbGVyLmV4aXQgPT09ICdmdW5jdGlvbicpID8ga2V5SGFuZGxlci5leGl0IDogbnVsbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBrZXlIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBub3JtYWxpemVkS2V5c1trZXldID0ge1xuICAgICAgICAgICAgICBlbnRlcjoga2V5SGFuZGxlcixcbiAgICAgICAgICAgICAgZXhpdDogbnVsbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbm9ybWFsaXplZFZpc2l0b3JbdHlwZV0gPSB7XG4gICAgICAgIGVudGVyOiAodHlwZW9mIGhhbmRsZXIuZW50ZXIgPT09ICdmdW5jdGlvbicpID8gaGFuZGxlci5lbnRlciA6IG51bGwsXG4gICAgICAgIGV4aXQ6ICh0eXBlb2YgaGFuZGxlci5leGl0ID09PSAnZnVuY3Rpb24nKSA/IGhhbmRsZXIuZXhpdCA6IG51bGwsXG4gICAgICAgIGtleXM6IG5vcm1hbGl6ZWRLZXlzXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIG5vcm1hbGl6ZWRWaXNpdG9yW3R5cGVdID0ge1xuICAgICAgICBlbnRlcjogaGFuZGxlcixcbiAgICAgICAgZXhpdDogbnVsbCxcbiAgICAgICAga2V5czogbm9ybWFsaXplZEtleXNcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5vcm1hbGl6ZWRWaXNpdG9yO1xufVxuIl19