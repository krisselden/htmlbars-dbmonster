exports.__esModule = true;

var _htmlbarsUtilObjectUtils = require("../htmlbars-util/object-utils");

var _htmlbarsUtilMorphUtils = require("../htmlbars-util/morph-utils");

/**
  Node classification:

  # Primary Statement Nodes:

  These nodes are responsible for a render node that represents a morph-range.

  * block
  * inline
  * content
  * element
  * component

  # Leaf Statement Nodes:

  This node is responsible for a render node that represents a morph-attr.

  * attribute

  # Expression Nodes:

  These nodes are not directly responsible for any part of the DOM, but are
  eventually passed to a Statement Node.

  * get
  * subexpr
  * concat
*/

var base = {
  acceptExpression: function (node, env, scope) {
    var ret = { value: null };

    // Primitive literals are unambiguously non-array representations of
    // themselves.
    if (typeof node !== 'object' || node === null) {
      ret.value = node;
      return ret;
    }

    switch (node[0]) {
      // can be used by manualElement
      case 'value':
        ret.value = node[1];break;
      case 'get':
        ret.value = this.get(node, env, scope);break;
      case 'subexpr':
        ret.value = this.subexpr(node, env, scope);break;
      case 'concat':
        ret.value = this.concat(node, env, scope);break;
    }

    return ret;
  },

  acceptParams: function (nodes, env, scope) {
    var arr = new Array(nodes.length);

    for (var i = 0, l = nodes.length; i < l; i++) {
      arr[i] = this.acceptExpression(nodes[i], env, scope).value;
    }

    return arr;
  },

  acceptHash: function (pairs, env, scope) {
    var object = {};

    for (var i = 0, l = pairs.length; i < l; i += 2) {
      object[pairs[i]] = this.acceptExpression(pairs[i + 1], env, scope).value;
    }

    return object;
  },

  // [ 'get', path ]
  get: function (node, env, scope) {
    return env.hooks.get(env, scope, node[1]);
  },

  // [ 'subexpr', path, params, hash ]
  subexpr: function (node, env, scope) {
    var path = node[1],
        params = node[2],
        hash = node[3];
    return env.hooks.subexpr(env, scope, path, this.acceptParams(params, env, scope), this.acceptHash(hash, env, scope));
  },

  // [ 'concat', parts ]
  concat: function (node, env, scope) {
    return env.hooks.concat(env, this.acceptParams(node[1], env, scope));
  },

  linkParamsAndHash: function (env, scope, morph, path, params, hash) {
    if (morph.linkedParams) {
      params = morph.linkedParams.params;
      hash = morph.linkedParams.hash;
    } else {
      params = params && this.acceptParams(params, env, scope);
      hash = hash && this.acceptHash(hash, env, scope);
    }

    _htmlbarsUtilMorphUtils.linkParams(env, scope, morph, path, params, hash);
    return [params, hash];
  }
};

var AlwaysDirtyVisitor = _htmlbarsUtilObjectUtils.merge(Object.create(base), {
  // [ 'block', path, params, hash, templateId, inverseId ]
  block: function (node, morph, env, scope, template, visitor) {
    var path = node[1],
        params = node[2],
        hash = node[3],
        templateId = node[4],
        inverseId = node[5];
    var paramsAndHash = this.linkParamsAndHash(env, scope, morph, path, params, hash);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.block(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], templateId === null ? null : template.templates[templateId], inverseId === null ? null : template.templates[inverseId], visitor);
  },

  // [ 'inline', path, params, hash ]
  inline: function (node, morph, env, scope, visitor) {
    var path = node[1],
        params = node[2],
        hash = node[3];
    var paramsAndHash = this.linkParamsAndHash(env, scope, morph, path, params, hash);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.inline(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], visitor);
  },

  // [ 'content', path ]
  content: function (node, morph, env, scope, visitor) {
    var path = node[1];

    morph.isDirty = morph.isSubtreeDirty = false;

    if (isHelper(env, scope, path)) {
      env.hooks.inline(morph, env, scope, path, [], {}, visitor);
      if (morph.linkedResult) {
        _htmlbarsUtilMorphUtils.linkParams(env, scope, morph, '@content-helper', [morph.linkedResult], null);
      }
      return;
    }

    var params;
    if (morph.linkedParams) {
      params = morph.linkedParams.params;
    } else {
      params = [env.hooks.get(env, scope, path)];
    }

    _htmlbarsUtilMorphUtils.linkParams(env, scope, morph, '@range', params, null);
    env.hooks.range(morph, env, scope, path, params[0], visitor);
  },

  // [ 'element', path, params, hash ]
  element: function (node, morph, env, scope, visitor) {
    var path = node[1],
        params = node[2],
        hash = node[3];
    var paramsAndHash = this.linkParamsAndHash(env, scope, morph, path, params, hash);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.element(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], visitor);
  },

  // [ 'attribute', name, value ]
  attribute: function (node, morph, env, scope) {
    var name = node[1],
        value = node[2];
    var paramsAndHash = this.linkParamsAndHash(env, scope, morph, '@attribute', [value], null);

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.attribute(morph, env, scope, name, paramsAndHash[0][0]);
  },

  // [ 'component', path, attrs, templateId, inverseId ]
  component: function (node, morph, env, scope, template, visitor) {
    var path = node[1],
        attrs = node[2],
        templateId = node[3],
        inverseId = node[4];
    var paramsAndHash = this.linkParamsAndHash(env, scope, morph, path, [], attrs);
    var templates = {
      default: template.templates[templateId],
      inverse: template.templates[inverseId]
    };

    morph.isDirty = morph.isSubtreeDirty = false;
    env.hooks.component(morph, env, scope, path, paramsAndHash[0], paramsAndHash[1], templates, visitor);
  },

  // [ 'attributes', template ]
  attributes: function (node, morph, env, scope, parentMorph, visitor) {
    var template = node[1];
    env.hooks.attributes(morph, env, scope, template, parentMorph, visitor);
  }
});

exports.AlwaysDirtyVisitor = AlwaysDirtyVisitor;
exports.default = _htmlbarsUtilObjectUtils.merge(Object.create(base), {
  // [ 'block', path, params, hash, templateId, inverseId ]
  block: function (node, morph, env, scope, template, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.block(node, morph, env, scope, template, visitor);
    });
  },

  // [ 'inline', path, params, hash ]
  inline: function (node, morph, env, scope, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.inline(node, morph, env, scope, visitor);
    });
  },

  // [ 'content', path ]
  content: function (node, morph, env, scope, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.content(node, morph, env, scope, visitor);
    });
  },

  // [ 'element', path, params, hash ]
  element: function (node, morph, env, scope, template, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.element(node, morph, env, scope, template, visitor);
    });
  },

  // [ 'attribute', name, value ]
  attribute: function (node, morph, env, scope, template) {
    dirtyCheck(env, morph, null, function () {
      AlwaysDirtyVisitor.attribute(node, morph, env, scope, template);
    });
  },

  // [ 'component', path, attrs, templateId ]
  component: function (node, morph, env, scope, template, visitor) {
    dirtyCheck(env, morph, visitor, function (visitor) {
      AlwaysDirtyVisitor.component(node, morph, env, scope, template, visitor);
    });
  },

  // [ 'attributes', template ]
  attributes: function (node, morph, env, scope, parentMorph, visitor) {
    AlwaysDirtyVisitor.attributes(node, morph, env, scope, parentMorph, visitor);
  }
});

function dirtyCheck(_env, morph, visitor, callback) {
  var isDirty = morph.isDirty;
  var isSubtreeDirty = morph.isSubtreeDirty;
  var env = _env;

  if (isSubtreeDirty) {
    visitor = AlwaysDirtyVisitor;
  }

  if (isDirty || isSubtreeDirty) {
    callback(visitor);
  } else {
    if (morph.buildChildEnv) {
      env = morph.buildChildEnv(morph.state, env);
    }
    _htmlbarsUtilMorphUtils.validateChildMorphs(env, morph, visitor);
  }
}

function isHelper(env, scope, path) {
  return env.hooks.keywords[path] !== undefined || env.hooks.hasHelper(env, scope, path);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLXJ1bnRpbWUvZXhwcmVzc2lvbi12aXNpdG9yLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O3VDQUFzQiwrQkFBK0I7O3NDQUNMLDhCQUE4Qjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQStCOUUsSUFBSSxJQUFJLEdBQUc7QUFDVCxrQkFBZ0IsRUFBRSxVQUFTLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFO0FBQzNDLFFBQUksR0FBRyxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDOzs7O0FBSTFCLFFBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7QUFDN0MsU0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDakIsYUFBTyxHQUFHLENBQUM7S0FDWjs7QUFFRCxZQUFPLElBQUksQ0FBQyxDQUFDLENBQUM7O0FBRVosV0FBSyxPQUFPO0FBQUUsV0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsQUFDekMsV0FBSyxLQUFLO0FBQUUsV0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsQUFDMUQsV0FBSyxTQUFTO0FBQUUsV0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsQUFDbEUsV0FBSyxRQUFRO0FBQUUsV0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsS0FDakU7O0FBRUQsV0FBTyxHQUFHLENBQUM7R0FDWjs7QUFFRCxjQUFZLEVBQUUsVUFBUyxLQUFLLEVB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QUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztLQUM3QztBQUNELDRCQS9QSyxtQkFBbUIsQ0ErUEosR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztHQUMxQztDQUNGOztBQUVELFNBQVMsUUFBUSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO0FBQ2xDLFNBQU8sQUFBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLElBQUssR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztDQUMxRiIsImZpbGUiOiJodG1sYmFycy1ydW50aW1lL2V4cHJlc3Npb24tdmlzaXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1lcmdlIH0gZnJvbSBcIi4uL2h0bWxiYXJzLXV0aWwvb2JqZWN0LXV0aWxzXCI7XG5pbXBvcnQgeyB2YWxpZGF0ZUNoaWxkTW9ycGhzLCBsaW5rUGFyYW1zIH0gZnJvbSBcIi4uL2h0bWxiYXJzLXV0aWwvbW9ycGgtdXRpbHNcIjtcblxuLyoqXG4gIE5vZGUgY2xhc3NpZmljYXRpb246XG5cbiAgIyBQcmltYXJ5IFN0YXRlbWVudCBOb2RlczpcblxuICBUaGVzZSBub2RlcyBhcmUgcmVzcG9uc2libGUgZm9yIGEgcmVuZGVyIG5vZGUgdGhhdCByZXByZXNlbnRzIGEgbW9ycGgtcmFuZ2UuXG5cbiAgKiBibG9ja1xuICAqIGlubGluZVxuICAqIGNvbnRlbnRcbiAgKiBlbGVtZW50XG4gICogY29tcG9uZW50XG5cbiAgIyBMZWFmIFN0YXRlbWVudCBOb2RlczpcblxuICBUaGlzIG5vZGUgaXMgcmVzcG9uc2libGUgZm9yIGEgcmVuZGVyIG5vZGUgdGhhdCByZXByZXNlbnRzIGEgbW9ycGgtYXR0ci5cblxuICAqIGF0dHJpYnV0ZVxuXG4gICMgRXhwcmVzc2lvbiBOb2RlczpcblxuICBUaGVzZSBub2RlcyBhcmUgbm90IGRpcmVjdGx5IHJlc3BvbnNpYmxlIGZvciBhbnkgcGFydCBvZiB0aGUgRE9NLCBidXQgYXJlXG4gIGV2ZW50dWFsbHkgcGFzc2VkIHRvIGEgU3RhdGVtZW50IE5vZGUuXG5cbiAgKiBnZXRcbiAgKiBzdWJleHByXG4gICogY29uY2F0XG4qL1xuXG52YXIgYmFzZSA9IHtcbiAgYWNjZXB0RXhwcmVzc2lvbjogZnVuY3Rpb24obm9kZSwgZW52LCBzY29wZSkge1xuICAgIHZhciByZXQgPSB7IHZhbHVlOiBudWxsIH07XG5cbiAgICAvLyBQcmltaXRpdmUgbGl0ZXJhbHMgYXJlIHVuYW1iaWd1b3VzbHkgbm9uLWFycmF5IHJlcHJlc2VudGF0aW9ucyBvZlxuICAgIC8vIHRoZW1zZWx2ZXMuXG4gICAgaWYgKHR5cGVvZiBub2RlICE9PSAnb2JqZWN0JyB8fCBub2RlID09PSBudWxsKSB7XG4gICAgICByZXQudmFsdWUgPSBub2RlO1xuICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG5cbiAgICBzd2l0Y2gobm9kZVswXSkge1xuICAgICAgLy8gY2FuIGJlIHVzZWQgYnkgbWFudWFsRWxlbWVudFxuICAgICAgY2FzZSAndmFsdWUnOiByZXQudmFsdWUgPSBub2RlWzFdOyBicmVhaztcbiAgICAgIGNhc2UgJ2dldCc6IHJldC52YWx1ZSA9IHRoaXMuZ2V0KG5vZGUsIGVudiwgc2NvcGUpOyBicmVhaztcbiAgICAgIGNhc2UgJ3N1YmV4cHInOiByZXQudmFsdWUgPSB0aGlzLnN1YmV4cHIobm9kZSwgZW52LCBzY29wZSk7IGJyZWFrO1xuICAgICAgY2FzZSAnY29uY2F0JzogcmV0LnZhbHVlID0gdGhpcy5jb25jYXQobm9kZSwgZW52LCBzY29wZSk7IGJyZWFrO1xuICAgIH1cblxuICAgIHJldHVybiByZXQ7XG4gIH0sXG5cbiAgYWNjZXB0UGFyYW1zOiBmdW5jdGlvbihub2RlcywgZW52LCBzY29wZSkge1xuICAgIHZhciBhcnIgPSBuZXcgQXJyYXkobm9kZXMubGVuZ3RoKTtcblxuICAgIGZvciAodmFyIGk9MCwgbD1ub2Rlcy5sZW5ndGg7IGk8bDsgaSsrKSB7XG4gICAgICBhcnJbaV0gPSB0aGlzLmFjY2VwdEV4cHJlc3Npb24obm9kZXNbaV0sIGVudiwgc2NvcGUpLnZhbHVlO1xuICAgIH1cblxuICAgIHJldHVybiBhcnI7XG4gIH0sXG5cbiAgYWNjZXB0SGFzaDogZnVuY3Rpb24ocGFpcnMsIGVudiwgc2NvcGUpIHtcbiAgICB2YXIgb2JqZWN0ID0ge307XG5cbiAgICBmb3IgKHZhciBpPTAsIGw9cGFpcnMubGVuZ3RoOyBpPGw7IGkgKz0gMikge1xuICAgICAgb2JqZWN0W3BhaXJzW2ldXSA9IHRoaXMuYWNjZXB0RXhwcmVzc2lvbihwYWlyc1tpKzFdLCBlbnYsIHNjb3BlKS52YWx1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gb2JqZWN0O1xuICB9LFxuXG4gIC8vIFsgJ2dldCcsIHBhdGggXVxuICBnZXQ6IGZ1bmN0aW9uKG5vZGUsIGVudiwgc2NvcGUpIHtcbiAgICByZXR1cm4gZW52Lmhvb2tzLmdldChlbnYsIHNjb3BlLCBub2RlWzFdKTtcbiAgfSxcblxuICAvLyBbICdzdWJleHByJywgcGF0aCwgcGFyYW1zLCBoYXNoIF1cbiAgc3ViZXhwcjogZnVuY3Rpb24obm9kZSwgZW52LCBzY29wZSkge1xuICAgIHZhciBwYXRoID0gbm9kZVsxXSwgcGFyYW1zID0gbm9kZVsyXSwgaGFzaCA9IG5vZGVbM107XG4gICAgcmV0dXJuIGVudi5ob29rcy5zdWJleHByKGVudiwgc2NvcGUsIHBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWNjZXB0UGFyYW1zKHBhcmFtcywgZW52LCBzY29wZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWNjZXB0SGFzaChoYXNoLCBlbnYsIHNjb3BlKSk7XG4gIH0sXG5cbiAgLy8gWyAnY29uY2F0JywgcGFydHMgXVxuICBjb25jYXQ6IGZ1bmN0aW9uKG5vZGUsIGVudiwgc2NvcGUpIHtcbiAgICByZXR1cm4gZW52Lmhvb2tzLmNvbmNhdChlbnYsIHRoaXMuYWNjZXB0UGFyYW1zKG5vZGVbMV0sIGVudiwgc2NvcGUpKTtcbiAgfSxcblxuICBsaW5rUGFyYW1zQW5kSGFzaDogZnVuY3Rpb24oZW52LCBzY29wZSwgbW9ycGgsIHBhdGgsIHBhcmFtcywgaGFzaCkge1xuICAgIGlmIChtb3JwaC5saW5rZWRQYXJhbXMpIHtcbiAgICAgIHBhcmFtcyA9IG1vcnBoLmxpbmtlZFBhcmFtcy5wYXJhbXM7XG4gICAgICBoYXNoID0gbW9ycGgubGlua2VkUGFyYW1zLmhhc2g7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcyA9IHBhcmFtcyAmJiB0aGlzLmFjY2VwdFBhcmFtcyhwYXJhbXMsIGVudiwgc2NvcGUpO1xuICAgICAgaGFzaCA9IGhhc2ggJiYgdGhpcy5hY2NlcHRIYXNoKGhhc2gsIGVudiwgc2NvcGUpO1xuICAgIH1cblxuICAgIGxpbmtQYXJhbXMoZW52LCBzY29wZSwgbW9ycGgsIHBhdGgsIHBhcmFtcywgaGFzaCk7XG4gICAgcmV0dXJuIFtwYXJhbXMsIGhhc2hdO1xuICB9XG59O1xuXG5leHBvcnQgdmFyIEFsd2F5c0RpcnR5VmlzaXRvciA9IG1lcmdlKE9iamVjdC5jcmVhdGUoYmFzZSksIHtcbiAgLy8gWyAnYmxvY2snLCBwYXRoLCBwYXJhbXMsIGhhc2gsIHRlbXBsYXRlSWQsIGludmVyc2VJZCBdXG4gIGJsb2NrOiBmdW5jdGlvbihub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpIHtcbiAgICB2YXIgcGF0aCA9IG5vZGVbMV0sIHBhcmFtcyA9IG5vZGVbMl0sIGhhc2ggPSBub2RlWzNdLCB0ZW1wbGF0ZUlkID0gbm9kZVs0XSwgaW52ZXJzZUlkID0gbm9kZVs1XTtcbiAgICB2YXIgcGFyYW1zQW5kSGFzaCA9IHRoaXMubGlua1BhcmFtc0FuZEhhc2goZW52LCBzY29wZSwgbW9ycGgsIHBhdGgsIHBhcmFtcywgaGFzaCk7XG5cbiAgICBtb3JwaC5pc0RpcnR5ID0gbW9ycGguaXNTdWJ0cmVlRGlydHkgPSBmYWxzZTtcbiAgICBlbnYuaG9va3MuYmxvY2sobW9ycGgsIGVudiwgc2NvcGUsIHBhdGgsIHBhcmFtc0FuZEhhc2hbMF0sIHBhcmFtc0FuZEhhc2hbMV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZUlkID09PSBudWxsID8gbnVsbCA6IHRlbXBsYXRlLnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmVyc2VJZCA9PT0gbnVsbCA/IG51bGwgOiB0ZW1wbGF0ZS50ZW1wbGF0ZXNbaW52ZXJzZUlkXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2l0b3IpO1xuICB9LFxuXG4gIC8vIFsgJ2lubGluZScsIHBhdGgsIHBhcmFtcywgaGFzaCBdXG4gIGlubGluZTogZnVuY3Rpb24obm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICB2YXIgcGF0aCA9IG5vZGVbMV0sIHBhcmFtcyA9IG5vZGVbMl0sIGhhc2ggPSBub2RlWzNdO1xuICAgIHZhciBwYXJhbXNBbmRIYXNoID0gdGhpcy5saW5rUGFyYW1zQW5kSGFzaChlbnYsIHNjb3BlLCBtb3JwaCwgcGF0aCwgcGFyYW1zLCBoYXNoKTtcblxuICAgIG1vcnBoLmlzRGlydHkgPSBtb3JwaC5pc1N1YnRyZWVEaXJ0eSA9IGZhbHNlO1xuICAgIGVudi5ob29rcy5pbmxpbmUobW9ycGgsIGVudiwgc2NvcGUsIHBhdGgsIHBhcmFtc0FuZEhhc2hbMF0sIHBhcmFtc0FuZEhhc2hbMV0sIHZpc2l0b3IpO1xuICB9LFxuXG4gIC8vIFsgJ2NvbnRlbnQnLCBwYXRoIF1cbiAgY29udGVudDogZnVuY3Rpb24obm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICB2YXIgcGF0aCA9IG5vZGVbMV07XG5cbiAgICBtb3JwaC5pc0RpcnR5ID0gbW9ycGguaXNTdWJ0cmVlRGlydHkgPSBmYWxzZTtcblxuICAgIGlmIChpc0hlbHBlcihlbnYsIHNjb3BlLCBwYXRoKSkge1xuICAgICAgZW52Lmhvb2tzLmlubGluZShtb3JwaCwgZW52LCBzY29wZSwgcGF0aCwgW10sIHt9LCB2aXNpdG9yKTtcbiAgICAgIGlmIChtb3JwaC5saW5rZWRSZXN1bHQpIHtcbiAgICAgICAgbGlua1BhcmFtcyhlbnYsIHNjb3BlLCBtb3JwaCwgJ0Bjb250ZW50LWhlbHBlcicsIFttb3JwaC5saW5rZWRSZXN1bHRdLCBudWxsKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgcGFyYW1zO1xuICAgIGlmIChtb3JwaC5saW5rZWRQYXJhbXMpIHtcbiAgICAgIHBhcmFtcyA9IG1vcnBoLmxpbmtlZFBhcmFtcy5wYXJhbXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcyA9IFtlbnYuaG9va3MuZ2V0KGVudiwgc2NvcGUsIHBhdGgpXTtcbiAgICB9XG5cbiAgICBsaW5rUGFyYW1zKGVudiwgc2NvcGUsIG1vcnBoLCAnQHJhbmdlJywgcGFyYW1zLCBudWxsKTtcbiAgICBlbnYuaG9va3MucmFuZ2UobW9ycGgsIGVudiwgc2NvcGUsIHBhdGgsIHBhcmFtc1swXSwgdmlzaXRvcik7XG4gIH0sXG5cbiAgLy8gWyAnZWxlbWVudCcsIHBhdGgsIHBhcmFtcywgaGFzaCBdXG4gIGVsZW1lbnQ6IGZ1bmN0aW9uKG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlLCB2aXNpdG9yKSB7XG4gICAgdmFyIHBhdGggPSBub2RlWzFdLCBwYXJhbXMgPSBub2RlWzJdLCBoYXNoID0gbm9kZVszXTtcbiAgICB2YXIgcGFyYW1zQW5kSGFzaCA9IHRoaXMubGlua1BhcmFtc0FuZEhhc2goZW52LCBzY29wZSwgbW9ycGgsIHBhdGgsIHBhcmFtcywgaGFzaCk7XG5cbiAgICBtb3JwaC5pc0RpcnR5ID0gbW9ycGguaXNTdWJ0cmVlRGlydHkgPSBmYWxzZTtcbiAgICBlbnYuaG9va3MuZWxlbWVudChtb3JwaCwgZW52LCBzY29wZSwgcGF0aCwgcGFyYW1zQW5kSGFzaFswXSwgcGFyYW1zQW5kSGFzaFsxXSwgdmlzaXRvcik7XG4gIH0sXG5cbiAgLy8gWyAnYXR0cmlidXRlJywgbmFtZSwgdmFsdWUgXVxuICBhdHRyaWJ1dGU6IGZ1bmN0aW9uKG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlKSB7XG4gICAgdmFyIG5hbWUgPSBub2RlWzFdLCB2YWx1ZSA9IG5vZGVbMl07XG4gICAgdmFyIHBhcmFtc0FuZEhhc2ggPSB0aGlzLmxpbmtQYXJhbXNBbmRIYXNoKGVudiwgc2NvcGUsIG1vcnBoLCAnQGF0dHJpYnV0ZScsIFt2YWx1ZV0sIG51bGwpO1xuXG4gICAgbW9ycGguaXNEaXJ0eSA9IG1vcnBoLmlzU3VidHJlZURpcnR5ID0gZmFsc2U7XG4gICAgZW52Lmhvb2tzLmF0dHJpYnV0ZShtb3JwaCwgZW52LCBzY29wZSwgbmFtZSwgcGFyYW1zQW5kSGFzaFswXVswXSk7XG4gIH0sXG5cbiAgLy8gWyAnY29tcG9uZW50JywgcGF0aCwgYXR0cnMsIHRlbXBsYXRlSWQsIGludmVyc2VJZCBdXG4gIGNvbXBvbmVudDogZnVuY3Rpb24obm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHRlbXBsYXRlLCB2aXNpdG9yKSB7XG4gICAgdmFyIHBhdGggPSBub2RlWzFdLCBhdHRycyA9IG5vZGVbMl0sIHRlbXBsYXRlSWQgPSBub2RlWzNdLCBpbnZlcnNlSWQgPSBub2RlWzRdO1xuICAgIHZhciBwYXJhbXNBbmRIYXNoID0gdGhpcy5saW5rUGFyYW1zQW5kSGFzaChlbnYsIHNjb3BlLCBtb3JwaCwgcGF0aCwgW10sIGF0dHJzKTtcbiAgICB2YXIgdGVtcGxhdGVzID0ge1xuICAgICAgZGVmYXVsdDogdGVtcGxhdGUudGVtcGxhdGVzW3RlbXBsYXRlSWRdLFxuICAgICAgaW52ZXJzZTogdGVtcGxhdGUudGVtcGxhdGVzW2ludmVyc2VJZF1cbiAgICB9O1xuXG4gICAgbW9ycGguaXNEaXJ0eSA9IG1vcnBoLmlzU3VidHJlZURpcnR5ID0gZmFsc2U7XG4gICAgZW52Lmhvb2tzLmNvbXBvbmVudChtb3JwaCwgZW52LCBzY29wZSwgcGF0aCwgcGFyYW1zQW5kSGFzaFswXSwgcGFyYW1zQW5kSGFzaFsxXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlcywgdmlzaXRvcik7XG4gIH0sXG5cbiAgLy8gWyAnYXR0cmlidXRlcycsIHRlbXBsYXRlIF1cbiAgYXR0cmlidXRlczogZnVuY3Rpb24obm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHBhcmVudE1vcnBoLCB2aXNpdG9yKSB7XG4gICAgbGV0IHRlbXBsYXRlID0gbm9kZVsxXTtcbiAgICBlbnYuaG9va3MuYXR0cmlidXRlcyhtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHBhcmVudE1vcnBoLCB2aXNpdG9yKTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IG1lcmdlKE9iamVjdC5jcmVhdGUoYmFzZSksIHtcbiAgLy8gWyAnYmxvY2snLCBwYXRoLCBwYXJhbXMsIGhhc2gsIHRlbXBsYXRlSWQsIGludmVyc2VJZCBdXG4gIGJsb2NrOiBmdW5jdGlvbihub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpIHtcbiAgICBkaXJ0eUNoZWNrKGVudiwgbW9ycGgsIHZpc2l0b3IsIGZ1bmN0aW9uKHZpc2l0b3IpIHtcbiAgICAgIEFsd2F5c0RpcnR5VmlzaXRvci5ibG9jayhub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpO1xuICAgIH0pO1xuICB9LFxuXG4gIC8vIFsgJ2lubGluZScsIHBhdGgsIHBhcmFtcywgaGFzaCBdXG4gIGlubGluZTogZnVuY3Rpb24obm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICBkaXJ0eUNoZWNrKGVudiwgbW9ycGgsIHZpc2l0b3IsIGZ1bmN0aW9uKHZpc2l0b3IpIHtcbiAgICAgIEFsd2F5c0RpcnR5VmlzaXRvci5pbmxpbmUobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpO1xuICAgIH0pO1xuICB9LFxuXG4gIC8vIFsgJ2NvbnRlbnQnLCBwYXRoIF1cbiAgY29udGVudDogZnVuY3Rpb24obm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpIHtcbiAgICBkaXJ0eUNoZWNrKGVudiwgbW9ycGgsIHZpc2l0b3IsIGZ1bmN0aW9uKHZpc2l0b3IpIHtcbiAgICAgIEFsd2F5c0RpcnR5VmlzaXRvci5jb250ZW50KG5vZGUsIG1vcnBoLCBlbnYsIHNjb3BlLCB2aXNpdG9yKTtcbiAgICB9KTtcbiAgfSxcblxuICAvLyBbICdlbGVtZW50JywgcGF0aCwgcGFyYW1zLCBoYXNoIF1cbiAgZWxlbWVudDogZnVuY3Rpb24obm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHRlbXBsYXRlLCB2aXNpdG9yKSB7XG4gICAgZGlydHlDaGVjayhlbnYsIG1vcnBoLCB2aXNpdG9yLCBmdW5jdGlvbih2aXNpdG9yKSB7XG4gICAgICBBbHdheXNEaXJ0eVZpc2l0b3IuZWxlbWVudChub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpO1xuICAgIH0pO1xuICB9LFxuXG4gIC8vIFsgJ2F0dHJpYnV0ZScsIG5hbWUsIHZhbHVlIF1cbiAgYXR0cmlidXRlOiBmdW5jdGlvbihub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUpIHtcbiAgICBkaXJ0eUNoZWNrKGVudiwgbW9ycGgsIG51bGwsIGZ1bmN0aW9uKCkge1xuICAgICAgQWx3YXlzRGlydHlWaXNpdG9yLmF0dHJpYnV0ZShub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUpO1xuICAgIH0pO1xuICB9LFxuXG4gIC8vIFsgJ2NvbXBvbmVudCcsIHBhdGgsIGF0dHJzLCB0ZW1wbGF0ZUlkIF1cbiAgY29tcG9uZW50OiBmdW5jdGlvbihub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpIHtcbiAgICBkaXJ0eUNoZWNrKGVudiwgbW9ycGgsIHZpc2l0b3IsIGZ1bmN0aW9uKHZpc2l0b3IpIHtcbiAgICAgIEFsd2F5c0RpcnR5VmlzaXRvci5jb21wb25lbnQobm9kZSwgbW9ycGgsIGVudiwgc2NvcGUsIHRlbXBsYXRlLCB2aXNpdG9yKTtcbiAgICB9KTtcbiAgfSxcblxuICAvLyBbICdhdHRyaWJ1dGVzJywgdGVtcGxhdGUgXVxuICBhdHRyaWJ1dGVzOiBmdW5jdGlvbihub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgcGFyZW50TW9ycGgsIHZpc2l0b3IpIHtcbiAgICBBbHdheXNEaXJ0eVZpc2l0b3IuYXR0cmlidXRlcyhub2RlLCBtb3JwaCwgZW52LCBzY29wZSwgcGFyZW50TW9ycGgsIHZpc2l0b3IpO1xuICB9XG59KTtcblxuZnVuY3Rpb24gZGlydHlDaGVjayhfZW52LCBtb3JwaCwgdmlzaXRvciwgY2FsbGJhY2spIHtcbiAgdmFyIGlzRGlydHkgPSBtb3JwaC5pc0RpcnR5O1xuICB2YXIgaXNTdWJ0cmVlRGlydHkgPSBtb3JwaC5pc1N1YnRyZWVEaXJ0eTtcbiAgdmFyIGVudiA9IF9lbnY7XG5cbiAgaWYgKGlzU3VidHJlZURpcnR5KSB7XG4gICAgdmlzaXRvciA9IEFsd2F5c0RpcnR5VmlzaXRvcjtcbiAgfVxuXG4gIGlmIChpc0RpcnR5IHx8IGlzU3VidHJlZURpcnR5KSB7XG4gICAgY2FsbGJhY2sodmlzaXRvcik7XG4gIH0gZWxzZSB7XG4gICAgaWYgKG1vcnBoLmJ1aWxkQ2hpbGRFbnYpIHtcbiAgICAgIGVudiA9IG1vcnBoLmJ1aWxkQ2hpbGRFbnYobW9ycGguc3RhdGUsIGVudik7XG4gICAgfVxuICAgIHZhbGlkYXRlQ2hpbGRNb3JwaHMoZW52LCBtb3JwaCwgdmlzaXRvcik7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNIZWxwZXIoZW52LCBzY29wZSwgcGF0aCkge1xuICByZXR1cm4gKGVudi5ob29rcy5rZXl3b3Jkc1twYXRoXSAhPT0gdW5kZWZpbmVkKSB8fCBlbnYuaG9va3MuaGFzSGVscGVyKGVudiwgc2NvcGUsIHBhdGgpO1xufVxuIl19