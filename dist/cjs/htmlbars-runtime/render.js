exports.__esModule = true;
exports.default = render;
exports.manualElement = manualElement;
exports.attachAttributes = attachAttributes;
exports.createChildMorph = createChildMorph;
exports.getCachedFragment = getCachedFragment;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _htmlbarsUtilArrayUtils = require("../htmlbars-util/array-utils");

var _htmlbarsUtilMorphUtils = require("../htmlbars-util/morph-utils");

var _expressionVisitor = require("./expression-visitor");

var _expressionVisitor2 = _interopRequireDefault(_expressionVisitor);

var _morph = require("./morph");

var _morph2 = _interopRequireDefault(_morph);

var _htmlbarsUtilTemplateUtils = require("../htmlbars-util/template-utils");

var _htmlbarsUtilVoidTagNames = require('../htmlbars-util/void-tag-names');

var _htmlbarsUtilVoidTagNames2 = _interopRequireDefault(_htmlbarsUtilVoidTagNames);

var svgNamespace = "http://www.w3.org/2000/svg";

function render(template, env, scope, options) {
  var dom = env.dom;
  var contextualElement;

  if (options) {
    if (options.renderNode) {
      contextualElement = options.renderNode.contextualElement;
    } else if (options.contextualElement) {
      contextualElement = options.contextualElement;
    }
  }

  dom.detectNamespace(contextualElement);

  var renderResult = RenderResult.build(env, scope, template, options, contextualElement);
  renderResult.render();

  return renderResult;
}

function RenderResult(env, scope, options, rootNode, ownerNode, nodes, fragment, template, shouldSetContent) {
  this.root = rootNode;
  this.fragment = fragment;

  this.nodes = nodes;
  this.template = template;
  this.statements = template.statements.slice();
  this.env = env;
  this.scope = scope;
  this.shouldSetContent = shouldSetContent;

  this.bindScope();

  if (options.attributes !== undefined) {
    nodes.push({ state: {} });
    this.statements.push(['attributes', attachAttributes(options.attributes)]);
  }

  if (options.self !== undefined) {
    this.bindSelf(options.self);
  }
  if (options.blockArguments !== undefined) {
    this.bindLocals(options.blockArguments);
  }

  this.initializeNodes(ownerNode);
}

RenderResult.build = function (env, scope, template, options, contextualElement) {
  var dom = env.dom;
  var fragment = getCachedFragment(template, env);
  var nodes = template.buildRenderNodes(dom, fragment, contextualElement);

  var rootNode, ownerNode, shouldSetContent;

  if (options && options.renderNode) {
    rootNode = options.renderNode;
    ownerNode = rootNode.ownerNode;
    shouldSetContent = true;
  } else {
    rootNode = dom.createMorph(null, fragment.firstChild, fragment.lastChild, contextualElement);
    ownerNode = rootNode;
    initializeNode(rootNode, ownerNode);
    shouldSetContent = false;
  }

  if (rootNode.childNodes) {
    _htmlbarsUtilMorphUtils.visitChildren(rootNode.childNodes, function (node) {
      _htmlbarsUtilTemplateUtils.clearMorph(node, env, true);
    });
  }

  rootNode.childNodes = nodes;
  return new RenderResult(env, scope, options, rootNode, ownerNode, nodes, fragment, template, shouldSetContent);
};

function manualElement(tagName, attributes) {
  var statements = [];

  for (var key in attributes) {
    if (typeof attributes[key] === 'string') {
      continue;
    }
    statements.push(["attribute", key, attributes[key]]);
  }

  statements.push(['content', 'yield']);

  var template = {
    arity: 0,
    cachedFragment: null,
    hasRendered: false,
    buildFragment: function buildFragment(dom) {
      var el0 = dom.createDocumentFragment();
      if (tagName === 'svg') {
        dom.setNamespace(svgNamespace);
      }
      var el1 = dom.createElement(tagName);

      for (var key in attributes) {
        if (typeof attributes[key] !== 'string') {
          continue;
        }
        dom.setAttribute(el1, key, attributes[key]);
      }

      if (!_htmlbarsUtilVoidTagNames2.default[tagName]) {
        var el2 = dom.createComment("");
        dom.appendChild(el1, el2);
      }

      dom.appendChild(el0, el1);

      return el0;
    },
    buildRenderNodes: function buildRenderNodes(dom, fragment) {
      var element = dom.childAt(fragment, [0]);
      var morphs = [];

      for (var key in attributes) {
        if (typeof attributes[key] === 'string') {
          continue;
        }
        morphs.push(dom.createAttrMorph(element, key));
      }

      morphs.push(dom.createMorphAt(element, 0, 0));
      return morphs;
    },
    statements: statements,
    locals: [],
    templates: []
  };

  return template;
}

function attachAttributes(attributes) {
  var statements = [];

  for (var key in attributes) {
    if (typeof attributes[key] === 'string') {
      continue;
    }
    statements.push(["attribute", key, attributes[key]]);
  }

  var template = {
    arity: 0,
    cachedFragment: null,
    hasRendered: false,
    buildFragment: function buildFragment(dom) {
      var el0 = this.element;
      if (el0.namespaceURI === "http://www.w3.org/2000/svg") {
        dom.setNamespace(svgNamespace);
      }
      for (var key in attributes) {
        if (typeof attributes[key] !== 'string') {
          continue;
        }
        dom.setAttribute(el0, key, attributes[key]);
      }

      return el0;
    },
    buildRenderNodes: function buildRenderNodes(dom) {
      var element = this.element;
      var morphs = [];

      for (var key in attributes) {
        if (typeof attributes[key] === 'string') {
          continue;
        }
        morphs.push(dom.createAttrMorph(element, key));
      }

      return morphs;
    },
    statements: statements,
    locals: [],
    templates: [],
    element: null
  };

  return template;
}

RenderResult.prototype.initializeNodes = function (ownerNode) {
  _htmlbarsUtilArrayUtils.forEach(this.root.childNodes, function (node) {
    initializeNode(node, ownerNode);
  });
};

RenderResult.prototype.render = function () {
  this.root.lastResult = this;
  this.root.rendered = true;
  this.populateNodes(_expressionVisitor.AlwaysDirtyVisitor);

  if (this.shouldSetContent && this.root.setContent) {
    this.root.setContent(this.fragment);
  }
};

RenderResult.prototype.dirty = function () {
  _htmlbarsUtilMorphUtils.visitChildren([this.root], function (node) {
    node.isDirty = true;
  });
};

RenderResult.prototype.revalidate = function (env, self, blockArguments, scope) {
  this.revalidateWith(env, scope, self, blockArguments, _expressionVisitor2.default);
};

RenderResult.prototype.rerender = function (env, self, blockArguments, scope) {
  this.revalidateWith(env, scope, self, blockArguments, _expressionVisitor.AlwaysDirtyVisitor);
};

RenderResult.prototype.revalidateWith = function (env, scope, self, blockArguments, visitor) {
  if (env !== undefined) {
    this.env = env;
  }
  if (scope !== undefined) {
    this.scope = scope;
  }
  this.updateScope();

  if (self !== undefined) {
    this.updateSelf(self);
  }
  if (blockArguments !== undefined) {
    this.updateLocals(blockArguments);
  }

  this.populateNodes(visitor);
};

RenderResult.prototype.destroy = function () {
  var rootNode = this.root;
  _htmlbarsUtilTemplateUtils.clearMorph(rootNode, this.env, true);
};

RenderResult.prototype.populateNodes = function (visitor) {
  var env = this.env;
  var scope = this.scope;
  var template = this.template;
  var nodes = this.nodes;
  var statements = this.statements;
  var i, l;

  for (i = 0, l = statements.length; i < l; i++) {
    var statement = statements[i];
    var morph = nodes[i];

    if (env.hooks.willRenderNode) {
      env.hooks.willRenderNode(morph, env, scope);
    }

    switch (statement[0]) {
      case 'block':
        visitor.block(statement, morph, env, scope, template, visitor);break;
      case 'inline':
        visitor.inline(statement, morph, env, scope, visitor);break;
      case 'content':
        visitor.content(statement, morph, env, scope, visitor);break;
      case 'element':
        visitor.element(statement, morph, env, scope, template, visitor);break;
      case 'attribute':
        visitor.attribute(statement, morph, env, scope);break;
      case 'component':
        visitor.component(statement, morph, env, scope, template, visitor);break;
      case 'attributes':
        visitor.attributes(statement, morph, env, scope, this.fragment, visitor);break;
    }

    if (env.hooks.didRenderNode) {
      env.hooks.didRenderNode(morph, env, scope);
    }
  }
};

RenderResult.prototype.bindScope = function () {
  this.env.hooks.bindScope(this.env, this.scope);
};

RenderResult.prototype.updateScope = function () {
  this.env.hooks.updateScope(this.env, this.scope);
};

RenderResult.prototype.bindSelf = function (self) {
  this.env.hooks.bindSelf(this.env, this.scope, self);
};

RenderResult.prototype.updateSelf = function (self) {
  this.env.hooks.updateSelf(this.env, this.scope, self);
};

RenderResult.prototype.bindLocals = function (blockArguments) {
  var localNames = this.template.locals;

  for (var i = 0, l = localNames.length; i < l; i++) {
    this.env.hooks.bindLocal(this.env, this.scope, localNames[i], blockArguments[i]);
  }
};

RenderResult.prototype.updateLocals = function (blockArguments) {
  var localNames = this.template.locals;

  for (var i = 0, l = localNames.length; i < l; i++) {
    this.env.hooks.updateLocal(this.env, this.scope, localNames[i], blockArguments[i]);
  }
};

function initializeNode(node, owner) {
  node.ownerNode = owner;
}

function createChildMorph(dom, parentMorph, contextualElement) {
  var morph = _morph2.default.empty(dom, contextualElement || parentMorph.contextualElement);
  initializeNode(morph, parentMorph.ownerNode);
  return morph;
}

function getCachedFragment(template, env) {
  var dom = env.dom,
      fragment;
  if (env.useFragmentCache && dom.canClone) {
    if (template.cachedFragment === null) {
      fragment = template.buildFragment(dom);
      if (template.hasRendered) {
        template.cachedFragment = fragment;
      } else {
        template.hasRendered = true;
      }
    }
    if (template.cachedFragment) {
      fragment = dom.cloneNode(template.cachedFragment, true);
    }
  } else if (!fragment) {
    fragment = template.buildFragment(dom);
  }

  return fragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLXJ1bnRpbWUvcmVuZGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7a0JBVXdCLE1BQU07UUF3RWQsYUFBYSxHQUFiLGFBQWE7UUF1RGIsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQTRKaEIsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQU1oQixpQkFBaUIsR0FBakIsaUJBQWlCOzs7O3NDQTNTVCw4QkFBOEI7O3NDQUN4Qiw4QkFBOEI7O2lDQUM5QixzQkFBc0I7Ozs7cUJBRWxDLFNBQVM7Ozs7eUNBQ0EsaUNBQWlDOzt3Q0FDeEMsaUNBQWlDOzs7O0FBRXJELElBQUksWUFBWSxHQUFHLDRCQUE0QixDQUFDOztBQUVqQyxTQUFTLE1BQU0sQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUU7QUFDNUQsTUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQztBQUNsQixNQUFJLGlCQUFpQixDQUFDOztBQUV0QixNQUFJLE9BQU8sRUFBRTtBQUNYLFFBQUksT0FBTyxDQUFDLFVBQVUsRUFBRTtBQUN0Qix1QkFBaUIsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDO0tBQzFELE1BQU0sSUFBSSxPQUFPLENBQUMsaUJBQWlCLEVBQUU7QUFDcEMsdUJBQWlCLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0tBQy9DO0dBQ0Y7O0FBRUQsS0FBRyxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDOztBQUV2QyxNQUFJLFlBQVksR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3hGLGNBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQzs7QUFFdEIsU0FBTyxZQUFZLENBQUM7Q0FDckI7O0FBRUQsU0FBUyxZQUFZLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNB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Y0FBUSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztLQUN6RDtHQUNGLE1BQU0sSUFBSSxDQUFDLFFBQVEsRUFBRTtBQUNwQixZQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztHQUN4Qzs7QUFFRCxTQUFPLFFBQVEsQ0FBQztDQUNqQiIsImZpbGUiOiJodG1sYmFycy1ydW50aW1lL3JlbmRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZvckVhY2ggfSBmcm9tIFwiLi4vaHRtbGJhcnMtdXRpbC9hcnJheS11dGlsc1wiO1xuaW1wb3J0IHsgdmlzaXRDaGlsZHJlbiB9IGZyb20gXCIuLi9odG1sYmFycy11dGlsL21vcnBoLXV0aWxzXCI7XG5pbXBvcnQgRXhwcmVzc2lvblZpc2l0b3IgZnJvbSBcIi4vZXhwcmVzc2lvbi12aXNpdG9yXCI7XG5pbXBvcnQgeyBBbHdheXNEaXJ0eVZpc2l0b3IgfSBmcm9tIFwiLi9leHByZXNzaW9uLXZpc2l0b3JcIjtcbmltcG9ydCBNb3JwaCBmcm9tIFwiLi9tb3JwaFwiO1xuaW1wb3J0IHsgY2xlYXJNb3JwaCB9IGZyb20gXCIuLi9odG1sYmFycy11dGlsL3RlbXBsYXRlLXV0aWxzXCI7XG5pbXBvcnQgdm9pZE1hcCBmcm9tICcuLi9odG1sYmFycy11dGlsL3ZvaWQtdGFnLW5hbWVzJztcblxudmFyIHN2Z05hbWVzcGFjZSA9IFwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIjtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcmVuZGVyKHRlbXBsYXRlLCBlbnYsIHNjb3BlLCBvcHRpb25zKSB7XG4gIHZhciBkb20gPSBlbnYuZG9tO1xuICB2YXIgY29udGV4dHVhbEVsZW1lbnQ7XG5cbiAgaWYgKG9wdGlvbnMpIHtcbiAgICBpZiAob3B0aW9ucy5yZW5kZXJOb2RlKSB7XG4gICAgICBjb250ZXh0dWFsRWxlbWVudCA9IG9wdGlvbnMucmVuZGVyTm9kZS5jb250ZXh0dWFsRWxlbWVudDtcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMuY29udGV4dHVhbEVsZW1lbnQpIHtcbiAgICAgIGNvbnRleHR1YWxFbGVtZW50ID0gb3B0aW9ucy5jb250ZXh0dWFsRWxlbWVudDtcbiAgICB9XG4gIH1cblxuICBkb20uZGV0ZWN0TmFtZXNwYWNlKGNvbnRleHR1YWxFbGVtZW50KTtcblxuICB2YXIgcmVuZGVyUmVzdWx0ID0gUmVuZGVyUmVzdWx0LmJ1aWxkKGVudiwgc2NvcGUsIHRlbXBsYXRlLCBvcHRpb25zLCBjb250ZXh0dWFsRWxlbWVudCk7XG4gIHJlbmRlclJlc3VsdC5yZW5kZXIoKTtcblxuICByZXR1cm4gcmVuZGVyUmVzdWx0O1xufVxuXG5mdW5jdGlvbiBSZW5kZXJSZXN1bHQoZW52LCBzY29wZSwgb3B0aW9ucywgcm9vdE5vZGUsIG93bmVyTm9kZSwgbm9kZXMsIGZyYWdtZW50LCB0ZW1wbGF0ZSwgc2hvdWxkU2V0Q29udGVudCkge1xuICB0aGlzLnJvb3QgPSByb290Tm9kZTtcbiAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50O1xuXG4gIHRoaXMubm9kZXMgPSBub2RlcztcbiAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICB0aGlzLnN0YXRlbWVudHMgPSB0ZW1wbGF0ZS5zdGF0ZW1lbnRzLnNsaWNlKCk7XG4gIHRoaXMuZW52ID0gZW52O1xuICB0aGlzLnNjb3BlID0gc2NvcGU7XG4gIHRoaXMuc2hvdWxkU2V0Q29udGVudCA9IHNob3VsZFNldENvbnRlbnQ7XG5cbiAgdGhpcy5iaW5kU2NvcGUoKTtcblxuICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzICE9PSB1bmRlZmluZWQpIHtcbiAgICBub2Rlcy5wdXNoKHsgc3RhdGU6IHt9IH0pO1xuICAgIHRoaXMuc3RhdGVtZW50cy5wdXNoKFsnYXR0cmlidXRlcycsIGF0dGFjaEF0dHJpYnV0ZXMob3B0aW9ucy5hdHRyaWJ1dGVzKV0pO1xuICB9XG5cbiAgaWYgKG9wdGlvbnMuc2VsZiAhPT0gdW5kZWZpbmVkKSB7IHRoaXMuYmluZFNlbGYob3B0aW9ucy5zZWxmKTsgfVxuICBpZiAob3B0aW9ucy5ibG9ja0FyZ3VtZW50cyAhPT0gdW5kZWZpbmVkKSB7IHRoaXMuYmluZExvY2FscyhvcHRpb25zLmJsb2NrQXJndW1lbnRzKTsgfVxuXG4gIHRoaXMuaW5pdGlhbGl6ZU5vZGVzKG93bmVyTm9kZSk7XG59XG5cblJlbmRlclJlc3VsdC5idWlsZCA9IGZ1bmN0aW9uKGVudiwgc2NvcGUsIHRlbXBsYXRlLCBvcHRpb25zLCBjb250ZXh0dWFsRWxlbWVudCkge1xuICB2YXIgZG9tID0gZW52LmRvbTtcbiAgdmFyIGZyYWdtZW50ID0gZ2V0Q2FjaGVkRnJhZ21lbnQodGVtcGxhdGUsIGVudik7XG4gIHZhciBub2RlcyA9IHRlbXBsYXRlLmJ1aWxkUmVuZGVyTm9kZXMoZG9tLCBmcmFnbWVudCwgY29udGV4dHVhbEVsZW1lbnQpO1xuXG4gIHZhciByb290Tm9kZSwgb3duZXJOb2RlLCBzaG91bGRTZXRDb250ZW50O1xuXG4gIGlmIChvcHRpb25zICYmIG9wdGlvbnMucmVuZGVyTm9kZSkge1xuICAgIHJvb3ROb2RlID0gb3B0aW9ucy5yZW5kZXJOb2RlO1xuICAgIG93bmVyTm9kZSA9IHJvb3ROb2RlLm93bmVyTm9kZTtcbiAgICBzaG91bGRTZXRDb250ZW50ID0gdHJ1ZTtcbiAgfSBlbHNlIHtcbiAgICByb290Tm9kZSA9IGRvbS5jcmVhdGVNb3JwaChudWxsLCBmcmFnbWVudC5maXJzdENoaWxkLCBmcmFnbWVudC5sYXN0Q2hpbGQsIGNvbnRleHR1YWxFbGVtZW50KTtcbiAgICBvd25lck5vZGUgPSByb290Tm9kZTtcbiAgICBpbml0aWFsaXplTm9kZShyb290Tm9kZSwgb3duZXJOb2RlKTtcbiAgICBzaG91bGRTZXRDb250ZW50ID0gZmFsc2U7XG4gIH1cblxuICBpZiAocm9vdE5vZGUuY2hpbGROb2Rlcykge1xuICAgIHZpc2l0Q2hpbGRyZW4ocm9vdE5vZGUuY2hpbGROb2RlcywgZnVuY3Rpb24obm9kZSkge1xuICAgICAgY2xlYXJNb3JwaChub2RlLCBlbnYsIHRydWUpO1xuICAgIH0pO1xuICB9XG5cbiAgcm9vdE5vZGUuY2hpbGROb2RlcyA9IG5vZGVzO1xuICByZXR1cm4gbmV3IFJlbmRlclJlc3VsdChlbnYsIHNjb3BlLCBvcHRpb25zLCByb290Tm9kZSwgb3duZXJOb2RlLCBub2RlcywgZnJhZ21lbnQsIHRlbXBsYXRlLCBzaG91bGRTZXRDb250ZW50KTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBtYW51YWxFbGVtZW50KHRhZ05hbWUsIGF0dHJpYnV0ZXMpIHtcbiAgdmFyIHN0YXRlbWVudHMgPSBbXTtcblxuICBmb3IgKHZhciBrZXkgaW4gYXR0cmlidXRlcykge1xuICAgIGlmICh0eXBlb2YgYXR0cmlidXRlc1trZXldID09PSAnc3RyaW5nJykgeyBjb250aW51ZTsgfVxuICAgIHN0YXRlbWVudHMucHVzaChbXCJhdHRyaWJ1dGVcIiwga2V5LCBhdHRyaWJ1dGVzW2tleV1dKTtcbiAgfVxuXG4gIHN0YXRlbWVudHMucHVzaChbJ2NvbnRlbnQnLCAneWllbGQnXSk7XG5cbiAgdmFyIHRlbXBsYXRlID0ge1xuICAgIGFyaXR5OiAwLFxuICAgIGNhY2hlZEZyYWdtZW50OiBudWxsLFxuICAgIGhhc1JlbmRlcmVkOiBmYWxzZSxcbiAgICBidWlsZEZyYWdtZW50OiBmdW5jdGlvbiBidWlsZEZyYWdtZW50KGRvbSkge1xuICAgICAgdmFyIGVsMCA9IGRvbS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gICAgICBpZiAodGFnTmFtZSA9PT0gJ3N2ZycpIHtcbiAgICAgICAgZG9tLnNldE5hbWVzcGFjZShzdmdOYW1lc3BhY2UpO1xuICAgICAgfVxuICAgICAgdmFyIGVsMSA9IGRvbS5jcmVhdGVFbGVtZW50KHRhZ05hbWUpO1xuXG4gICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cmlidXRlcykge1xuICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZXNba2V5XSAhPT0gJ3N0cmluZycpIHsgY29udGludWU7IH1cbiAgICAgICAgZG9tLnNldEF0dHJpYnV0ZShlbDEsIGtleSwgYXR0cmlidXRlc1trZXldKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCF2b2lkTWFwW3RhZ05hbWVdKSB7XG4gICAgICAgIHZhciBlbDIgPSBkb20uY3JlYXRlQ29tbWVudChcIlwiKTtcbiAgICAgICAgZG9tLmFwcGVuZENoaWxkKGVsMSwgZWwyKTtcbiAgICAgIH1cblxuICAgICAgZG9tLmFwcGVuZENoaWxkKGVsMCwgZWwxKTtcblxuICAgICAgcmV0dXJuIGVsMDtcbiAgICB9LFxuICAgIGJ1aWxkUmVuZGVyTm9kZXM6IGZ1bmN0aW9uIGJ1aWxkUmVuZGVyTm9kZXMoZG9tLCBmcmFnbWVudCkge1xuICAgICAgdmFyIGVsZW1lbnQgPSBkb20uY2hpbGRBdChmcmFnbWVudCwgWzBdKTtcbiAgICAgIHZhciBtb3JwaHMgPSBbXTtcblxuICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJpYnV0ZXMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVzW2tleV0gPT09ICdzdHJpbmcnKSB7IGNvbnRpbnVlOyB9XG4gICAgICAgIG1vcnBocy5wdXNoKGRvbS5jcmVhdGVBdHRyTW9ycGgoZWxlbWVudCwga2V5KSk7XG4gICAgICB9XG5cbiAgICAgIG1vcnBocy5wdXNoKGRvbS5jcmVhdGVNb3JwaEF0KGVsZW1lbnQsIDAsIDApKTtcbiAgICAgIHJldHVybiBtb3JwaHM7XG4gICAgfSxcbiAgICBzdGF0ZW1lbnRzOiBzdGF0ZW1lbnRzLFxuICAgIGxvY2FsczogW10sXG4gICAgdGVtcGxhdGVzOiBbXVxuICB9O1xuXG4gIHJldHVybiB0ZW1wbGF0ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaEF0dHJpYnV0ZXMoYXR0cmlidXRlcykge1xuICB2YXIgc3RhdGVtZW50cyA9IFtdO1xuXG4gIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVzW2tleV0gPT09ICdzdHJpbmcnKSB7IGNvbnRpbnVlOyB9XG4gICAgc3RhdGVtZW50cy5wdXNoKFtcImF0dHJpYnV0ZVwiLCBrZXksIGF0dHJpYnV0ZXNba2V5XV0pO1xuICB9XG5cbiAgdmFyIHRlbXBsYXRlID0ge1xuICAgIGFyaXR5OiAwLFxuICAgIGNhY2hlZEZyYWdtZW50OiBudWxsLFxuICAgIGhhc1JlbmRlcmVkOiBmYWxzZSxcbiAgICBidWlsZEZyYWdtZW50OiBmdW5jdGlvbiBidWlsZEZyYWdtZW50KGRvbSkge1xuICAgICAgdmFyIGVsMCA9IHRoaXMuZWxlbWVudDtcbiAgICAgIGlmIChlbDAubmFtZXNwYWNlVVJJID09PSBcImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCIpIHtcbiAgICAgICAgZG9tLnNldE5hbWVzcGFjZShzdmdOYW1lc3BhY2UpO1xuICAgICAgfVxuICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJpYnV0ZXMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVzW2tleV0gIT09ICdzdHJpbmcnKSB7IGNvbnRpbnVlOyB9XG4gICAgICAgIGRvbS5zZXRBdHRyaWJ1dGUoZWwwLCBrZXksIGF0dHJpYnV0ZXNba2V5XSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBlbDA7XG4gICAgfSxcbiAgICBidWlsZFJlbmRlck5vZGVzOiBmdW5jdGlvbiBidWlsZFJlbmRlck5vZGVzKGRvbSkge1xuICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7XG4gICAgICB2YXIgbW9ycGhzID0gW107XG5cbiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlc1trZXldID09PSAnc3RyaW5nJykgeyBjb250aW51ZTsgfVxuICAgICAgICBtb3JwaHMucHVzaChkb20uY3JlYXRlQXR0ck1vcnBoKGVsZW1lbnQsIGtleSkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbW9ycGhzO1xuICAgIH0sXG4gICAgc3RhdGVtZW50czogc3RhdGVtZW50cyxcbiAgICBsb2NhbHM6IFtdLFxuICAgIHRlbXBsYXRlczogW10sXG4gICAgZWxlbWVudDogbnVsbFxuICB9O1xuXG4gIHJldHVybiB0ZW1wbGF0ZTtcbn1cblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5pbml0aWFsaXplTm9kZXMgPSBmdW5jdGlvbihvd25lck5vZGUpIHtcbiAgZm9yRWFjaCh0aGlzLnJvb3QuY2hpbGROb2RlcywgZnVuY3Rpb24obm9kZSkge1xuICAgIGluaXRpYWxpemVOb2RlKG5vZGUsIG93bmVyTm9kZSk7XG4gIH0pO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5yb290Lmxhc3RSZXN1bHQgPSB0aGlzO1xuICB0aGlzLnJvb3QucmVuZGVyZWQgPSB0cnVlO1xuICB0aGlzLnBvcHVsYXRlTm9kZXMoQWx3YXlzRGlydHlWaXNpdG9yKTtcblxuICBpZiAodGhpcy5zaG91bGRTZXRDb250ZW50ICYmIHRoaXMucm9vdC5zZXRDb250ZW50KSB7XG4gICAgdGhpcy5yb290LnNldENvbnRlbnQodGhpcy5mcmFnbWVudCk7XG4gIH1cbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUuZGlydHkgPSBmdW5jdGlvbigpIHtcbiAgdmlzaXRDaGlsZHJlbihbdGhpcy5yb290XSwgZnVuY3Rpb24obm9kZSkgeyBub2RlLmlzRGlydHkgPSB0cnVlOyB9KTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUucmV2YWxpZGF0ZSA9IGZ1bmN0aW9uKGVudiwgc2VsZiwgYmxvY2tBcmd1bWVudHMsIHNjb3BlKSB7XG4gIHRoaXMucmV2YWxpZGF0ZVdpdGgoZW52LCBzY29wZSwgc2VsZiwgYmxvY2tBcmd1bWVudHMsIEV4cHJlc3Npb25WaXNpdG9yKTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUucmVyZW5kZXIgPSBmdW5jdGlvbihlbnYsIHNlbGYsIGJsb2NrQXJndW1lbnRzLCBzY29wZSkge1xuICB0aGlzLnJldmFsaWRhdGVXaXRoKGVudiwgc2NvcGUsIHNlbGYsIGJsb2NrQXJndW1lbnRzLCBBbHdheXNEaXJ0eVZpc2l0b3IpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5yZXZhbGlkYXRlV2l0aCA9IGZ1bmN0aW9uKGVudiwgc2NvcGUsIHNlbGYsIGJsb2NrQXJndW1lbnRzLCB2aXNpdG9yKSB7XG4gIGlmIChlbnYgIT09IHVuZGVmaW5lZCkgeyB0aGlzLmVudiA9IGVudjsgfVxuICBpZiAoc2NvcGUgIT09IHVuZGVmaW5lZCkgeyB0aGlzLnNjb3BlID0gc2NvcGU7IH1cbiAgdGhpcy51cGRhdGVTY29wZSgpO1xuXG4gIGlmIChzZWxmICE9PSB1bmRlZmluZWQpIHsgdGhpcy51cGRhdGVTZWxmKHNlbGYpOyB9XG4gIGlmIChibG9ja0FyZ3VtZW50cyAhPT0gdW5kZWZpbmVkKSB7IHRoaXMudXBkYXRlTG9jYWxzKGJsb2NrQXJndW1lbnRzKTsgfVxuXG4gIHRoaXMucG9wdWxhdGVOb2Rlcyh2aXNpdG9yKTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkge1xuICB2YXIgcm9vdE5vZGUgPSB0aGlzLnJvb3Q7XG4gIGNsZWFyTW9ycGgocm9vdE5vZGUsIHRoaXMuZW52LCB0cnVlKTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUucG9wdWxhdGVOb2RlcyA9IGZ1bmN0aW9uKHZpc2l0b3IpIHtcbiAgdmFyIGVudiA9IHRoaXMuZW52O1xuICB2YXIgc2NvcGUgPSB0aGlzLnNjb3BlO1xuICB2YXIgdGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlO1xuICB2YXIgbm9kZXMgPSB0aGlzLm5vZGVzO1xuICB2YXIgc3RhdGVtZW50cyA9IHRoaXMuc3RhdGVtZW50cztcbiAgdmFyIGksIGw7XG5cbiAgZm9yIChpPTAsIGw9c3RhdGVtZW50cy5sZW5ndGg7IGk8bDsgaSsrKSB7XG4gICAgdmFyIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07XG4gICAgdmFyIG1vcnBoID0gbm9kZXNbaV07XG5cbiAgICBpZiAoZW52Lmhvb2tzLndpbGxSZW5kZXJOb2RlKSB7XG4gICAgICBlbnYuaG9va3Mud2lsbFJlbmRlck5vZGUobW9ycGgsIGVudiwgc2NvcGUpO1xuICAgIH1cblxuICAgIHN3aXRjaCAoc3RhdGVtZW50WzBdKSB7XG4gICAgICBjYXNlICdibG9jayc6IHZpc2l0b3IuYmxvY2soc3RhdGVtZW50LCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpOyBicmVhaztcbiAgICAgIGNhc2UgJ2lubGluZSc6IHZpc2l0b3IuaW5saW5lKHN0YXRlbWVudCwgbW9ycGgsIGVudiwgc2NvcGUsIHZpc2l0b3IpOyBicmVhaztcbiAgICAgIGNhc2UgJ2NvbnRlbnQnOiB2aXNpdG9yLmNvbnRlbnQoc3RhdGVtZW50LCBtb3JwaCwgZW52LCBzY29wZSwgdmlzaXRvcik7IGJyZWFrO1xuICAgICAgY2FzZSAnZWxlbWVudCc6IHZpc2l0b3IuZWxlbWVudChzdGF0ZW1lbnQsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgdmlzaXRvcik7IGJyZWFrO1xuICAgICAgY2FzZSAnYXR0cmlidXRlJzogdmlzaXRvci5hdHRyaWJ1dGUoc3RhdGVtZW50LCBtb3JwaCwgZW52LCBzY29wZSk7IGJyZWFrO1xuICAgICAgY2FzZSAnY29tcG9uZW50JzogdmlzaXRvci5jb21wb25lbnQoc3RhdGVtZW50LCBtb3JwaCwgZW52LCBzY29wZSwgdGVtcGxhdGUsIHZpc2l0b3IpOyBicmVhaztcbiAgICAgIGNhc2UgJ2F0dHJpYnV0ZXMnOiB2aXNpdG9yLmF0dHJpYnV0ZXMoc3RhdGVtZW50LCBtb3JwaCwgZW52LCBzY29wZSwgdGhpcy5mcmFnbWVudCwgdmlzaXRvcik7IGJyZWFrO1xuICAgIH1cblxuICAgIGlmIChlbnYuaG9va3MuZGlkUmVuZGVyTm9kZSkge1xuICAgICAgZW52Lmhvb2tzLmRpZFJlbmRlck5vZGUobW9ycGgsIGVudiwgc2NvcGUpO1xuICAgIH1cbiAgfVxufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5iaW5kU2NvcGUgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5lbnYuaG9va3MuYmluZFNjb3BlKHRoaXMuZW52LCB0aGlzLnNjb3BlKTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUudXBkYXRlU2NvcGUgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5lbnYuaG9va3MudXBkYXRlU2NvcGUodGhpcy5lbnYsIHRoaXMuc2NvcGUpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5iaW5kU2VsZiA9IGZ1bmN0aW9uKHNlbGYpIHtcbiAgdGhpcy5lbnYuaG9va3MuYmluZFNlbGYodGhpcy5lbnYsIHRoaXMuc2NvcGUsIHNlbGYpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS51cGRhdGVTZWxmID0gZnVuY3Rpb24oc2VsZikge1xuICB0aGlzLmVudi5ob29rcy51cGRhdGVTZWxmKHRoaXMuZW52LCB0aGlzLnNjb3BlLCBzZWxmKTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUuYmluZExvY2FscyA9IGZ1bmN0aW9uKGJsb2NrQXJndW1lbnRzKSB7XG4gIHZhciBsb2NhbE5hbWVzID0gdGhpcy50ZW1wbGF0ZS5sb2NhbHM7XG5cbiAgZm9yICh2YXIgaT0wLCBsPWxvY2FsTmFtZXMubGVuZ3RoOyBpPGw7IGkrKykge1xuICAgIHRoaXMuZW52Lmhvb2tzLmJpbmRMb2NhbCh0aGlzLmVudiwgdGhpcy5zY29wZSwgbG9jYWxOYW1lc1tpXSwgYmxvY2tBcmd1bWVudHNbaV0pO1xuICB9XG59O1xuXG5SZW5kZXJSZXN1bHQucHJvdG90eXBlLnVwZGF0ZUxvY2FscyA9IGZ1bmN0aW9uKGJsb2NrQXJndW1lbnRzKSB7XG4gIHZhciBsb2NhbE5hbWVzID0gdGhpcy50ZW1wbGF0ZS5sb2NhbHM7XG5cbiAgZm9yICh2YXIgaT0wLCBsPWxvY2FsTmFtZXMubGVuZ3RoOyBpPGw7IGkrKykge1xuICAgIHRoaXMuZW52Lmhvb2tzLnVwZGF0ZUxvY2FsKHRoaXMuZW52LCB0aGlzLnNjb3BlLCBsb2NhbE5hbWVzW2ldLCBibG9ja0FyZ3VtZW50c1tpXSk7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGluaXRpYWxpemVOb2RlKG5vZGUsIG93bmVyKSB7XG4gIG5vZGUub3duZXJOb2RlID0gb3duZXI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDaGlsZE1vcnBoKGRvbSwgcGFyZW50TW9ycGgsIGNvbnRleHR1YWxFbGVtZW50KSB7XG4gIHZhciBtb3JwaCA9IE1vcnBoLmVtcHR5KGRvbSwgY29udGV4dHVhbEVsZW1lbnQgfHwgcGFyZW50TW9ycGguY29udGV4dHVhbEVsZW1lbnQpO1xuICBpbml0aWFsaXplTm9kZShtb3JwaCwgcGFyZW50TW9ycGgub3duZXJOb2RlKTtcbiAgcmV0dXJuIG1vcnBoO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2FjaGVkRnJhZ21lbnQodGVtcGxhdGUsIGVudikge1xuICB2YXIgZG9tID0gZW52LmRvbSwgZnJhZ21lbnQ7XG4gIGlmIChlbnYudXNlRnJhZ21lbnRDYWNoZSAmJiBkb20uY2FuQ2xvbmUpIHtcbiAgICBpZiAodGVtcGxhdGUuY2FjaGVkRnJhZ21lbnQgPT09IG51bGwpIHtcbiAgICAgIGZyYWdtZW50ID0gdGVtcGxhdGUuYnVpbGRGcmFnbWVudChkb20pO1xuICAgICAgaWYgKHRlbXBsYXRlLmhhc1JlbmRlcmVkKSB7XG4gICAgICAgIHRlbXBsYXRlLmNhY2hlZEZyYWdtZW50ID0gZnJhZ21lbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0ZW1wbGF0ZS5oYXNSZW5kZXJlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0ZW1wbGF0ZS5jYWNoZWRGcmFnbWVudCkge1xuICAgICAgZnJhZ21lbnQgPSBkb20uY2xvbmVOb2RlKHRlbXBsYXRlLmNhY2hlZEZyYWdtZW50LCB0cnVlKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoIWZyYWdtZW50KSB7XG4gICAgZnJhZ21lbnQgPSB0ZW1wbGF0ZS5idWlsZEZyYWdtZW50KGRvbSk7XG4gIH1cblxuICByZXR1cm4gZnJhZ21lbnQ7XG59XG4iXX0=