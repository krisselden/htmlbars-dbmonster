exports.__esModule = true;

var _utils = require("./utils");

var _htmlbarsUtilQuoting = require("../htmlbars-util/quoting");

var svgNamespace = "http://www.w3.org/2000/svg",

// http://www.w3.org/html/wg/drafts/html/master/syntax.html#html-integration-point
svgHTMLIntegrationPoints = { 'foreignObject': true, 'desc': true, 'title': true };

function FragmentJavaScriptCompiler() {
  this.source = [];
  this.depth = -1;
}

exports.default = FragmentJavaScriptCompiler;

FragmentJavaScriptCompiler.prototype.compile = function (opcodes, options) {
  this.source.length = 0;
  this.depth = -1;
  this.indent = options && options.indent || "";
  this.namespaceFrameStack = [{ namespace: null, depth: null }];
  this.domNamespace = null;

  this.source.push('function buildFragment(dom) {\n');
  _utils.processOpcodes(this, opcodes);
  this.source.push(this.indent + '}');

  return this.source.join('');
};

FragmentJavaScriptCompiler.prototype.createFragment = function () {
  var el = 'el' + ++this.depth;
  this.source.push(this.indent + '  var ' + el + ' = dom.createDocumentFragment();\n');
};

FragmentJavaScriptCompiler.prototype.createElement = function (tagName) {
  var el = 'el' + ++this.depth;
  if (tagName === 'svg') {
    this.pushNamespaceFrame({ namespace: svgNamespace, depth: this.depth });
  }
  this.ensureNamespace();
  this.source.push(this.indent + '  var ' + el + ' = dom.createElement(' + _htmlbarsUtilQuoting.string(tagName) + ');\n');
  if (svgHTMLIntegrationPoints[tagName]) {
    this.pushNamespaceFrame({ namespace: null, depth: this.depth });
  }
};

FragmentJavaScriptCompiler.prototype.createText = function (str) {
  var el = 'el' + ++this.depth;
  this.source.push(this.indent + '  var ' + el + ' = dom.createTextNode(' + _htmlbarsUtilQuoting.string(str) + ');\n');
};

FragmentJavaScriptCompiler.prototype.createComment = function (str) {
  var el = 'el' + ++this.depth;
  this.source.push(this.indent + '  var ' + el + ' = dom.createComment(' + _htmlbarsUtilQuoting.string(str) + ');\n');
};

FragmentJavaScriptCompiler.prototype.returnNode = function () {
  var el = 'el' + this.depth;
  this.source.push(this.indent + '  return ' + el + ';\n');
};

FragmentJavaScriptCompiler.prototype.setAttribute = function (name, value, namespace) {
  var el = 'el' + this.depth;
  if (namespace) {
    this.source.push(this.indent + '  dom.setAttributeNS(' + el + ',' + _htmlbarsUtilQuoting.string(namespace) + ',' + _htmlbarsUtilQuoting.string(name) + ',' + _htmlbarsUtilQuoting.string(value) + ');\n');
  } else {
    this.source.push(this.indent + '  dom.setAttribute(' + el + ',' + _htmlbarsUtilQuoting.string(name) + ',' + _htmlbarsUtilQuoting.string(value) + ');\n');
  }
};

FragmentJavaScriptCompiler.prototype.appendChild = function () {
  if (this.depth === this.getCurrentNamespaceFrame().depth) {
    this.popNamespaceFrame();
  }
  var child = 'el' + this.depth--;
  var el = 'el' + this.depth;
  this.source.push(this.indent + '  dom.appendChild(' + el + ', ' + child + ');\n');
};

FragmentJavaScriptCompiler.prototype.getCurrentNamespaceFrame = function () {
  return this.namespaceFrameStack[this.namespaceFrameStack.length - 1];
};

FragmentJavaScriptCompiler.prototype.pushNamespaceFrame = function (frame) {
  this.namespaceFrameStack.push(frame);
};

FragmentJavaScriptCompiler.prototype.popNamespaceFrame = function () {
  return this.namespaceFrameStack.pop();
};

FragmentJavaScriptCompiler.prototype.ensureNamespace = function () {
  var correctNamespace = this.getCurrentNamespaceFrame().namespace;
  if (this.domNamespace !== correctNamespace) {
    this.source.push(this.indent + '  dom.setNamespace(' + (correctNamespace ? _htmlbarsUtilQuoting.string(correctNamespace) : 'null') + ');\n');
    this.domNamespace = correctNamespace;
  }
};
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLWNvbXBpbGVyL2ZyYWdtZW50LWphdmFzY3JpcHQtY29tcGlsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7cUJBQStCLFNBQVM7O21DQUNqQiwwQkFBMEI7O0FBRWpELElBQUksWUFBWSxHQUFHLDRCQUE0Qjs7O0FBRTNDLHdCQUF3QixHQUFHLEVBQUMsZUFBZSxFQUFDLElBQUksRUFBRSxNQUFNLEVBQUMsSUFBSSxFQUFFLE9BQU8sRUFBQyxJQUFJLEVBQUMsQ0FBQzs7QUFHakYsU0FBUywwQkFBMEIsR0FBRztBQUNwQyxNQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUNqQixNQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO0NBQ2pCOztrQkFFYywwQkFBMEI7O0FBRXpDLDBCQUEwQixDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBUyxPQUFPLEVBQUUsT0FBTyxFQUFFO0FBQ3hFLE1BQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUN2QixNQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ2hCLE1BQUksQ0FBQyxNQUFNLEdBQUcsQUFBQyxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSyxFQUFFLENBQUM7QUFDaEQsTUFBSSxDQUFDLG1CQUFtQixHQUFHLENBQUMsRUFBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0FBQzVELE1BQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDOztBQUV6QixNQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQ3BELFNBdkJPLGNBQWMsQ0F1Qk4sSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQzlCLE1BQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUMsR0FBRyxDQUFDLENBQUM7O0FBRWxDLFNBQU8s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RTtBQUN4RSxNQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0NBQ3RDLENBQUM7O0FBRUYsMEJBQTBCLENBQUMsU0FBUyxDQUFDLGlCQUFpQixHQUFHLFlBQVc7QUFDbEUsU0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxFQUFFLENBQUM7Q0FDdkMsQ0FBQzs7QUFFRiwwQkFBMEIsQ0FBQyxTQUFTLENBQUMsZUFBZSxHQUFHLFlBQVc7QUFDaEUsTUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxTQUFTLENBQUM7QUFDakUsTUFBSSxJQUFJLENBQUMsWUFBWSxLQUFLLGdCQUFnQixFQUFFO0FBQzFDLFFBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUMscUJBQXFCLElBQUUsZ0JBQWdCLEdBQUcscUJBN0ZsRSxNQUFNLENBNkZtRSxnQkFBZ0IsQ0FBQyxHQUFHLE1BQU0sQ0FBQSxBQUFDLEdBQUMsTUFBTSxDQUFDLENBQUM7QUFDbEgsUUFBSSxDQUFDLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQztHQUN0QztDQUNGLENBQUMiLCJmaWxlIjoiaHRtbGJhcnMtY29tcGlsZXIvZnJhZ21lbnQtamF2YXNjcmlwdC1jb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHByb2Nlc3NPcGNvZGVzIH0gZnJvbSBcIi4vdXRpbHNcIjtcbmltcG9ydCB7IHN0cmluZyB9IGZyb20gXCIuLi9odG1sYmFycy11dGlsL3F1b3RpbmdcIjtcblxudmFyIHN2Z05hbWVzcGFjZSA9IFwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIixcbi8vIGh0dHA6Ly93d3cudzMub3JnL2h0bWwvd2cvZHJhZnRzL2h0bWwvbWFzdGVyL3N5bnRheC5odG1sI2h0bWwtaW50ZWdyYXRpb24tcG9pbnRcbiAgICBzdmdIVE1MSW50ZWdyYXRpb25Qb2ludHMgPSB7J2ZvcmVpZ25PYmplY3QnOnRydWUsICdkZXNjJzp0cnVlLCAndGl0bGUnOnRydWV9O1xuXG5cbmZ1bmN0aW9uIEZyYWdtZW50SmF2YVNjcmlwdENvbXBpbGVyKCkge1xuICB0aGlzLnNvdXJjZSA9IFtdO1xuICB0aGlzLmRlcHRoID0gLTE7XG59XG5cbmV4cG9ydCBkZWZhdWx0IEZyYWdtZW50SmF2YVNjcmlwdENvbXBpbGVyO1xuXG5GcmFnbWVudEphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUuY29tcGlsZSA9IGZ1bmN0aW9uKG9wY29kZXMsIG9wdGlvbnMpIHtcbiAgdGhpcy5zb3VyY2UubGVuZ3RoID0gMDtcbiAgdGhpcy5kZXB0aCA9IC0xO1xuICB0aGlzLmluZGVudCA9IChvcHRpb25zICYmIG9wdGlvbnMuaW5kZW50KSB8fCBcIlwiO1xuICB0aGlzLm5hbWVzcGFjZUZyYW1lU3RhY2sgPSBbe25hbWVzcGFjZTogbnVsbCwgZGVwdGg6IG51bGx9XTtcbiAgdGhpcy5kb21OYW1lc3BhY2UgPSBudWxsO1xuXG4gIHRoaXMuc291cmNlLnB1c2goJ2Z1bmN0aW9uIGJ1aWxkRnJhZ21lbnQoZG9tKSB7XFxuJyk7XG4gIHByb2Nlc3NPcGNvZGVzKHRoaXMsIG9wY29kZXMpO1xuICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuaW5kZW50Kyd9Jyk7XG5cbiAgcmV0dXJuIHRoaXMuc291cmNlLmpvaW4oJycpO1xufTtcblxuRnJhZ21lbnRKYXZhU2NyaXB0Q29tcGlsZXIucHJvdG90eXBlLmNyZWF0ZUZyYWdtZW50ID0gZnVuY3Rpb24oKSB7XG4gIHZhciBlbCA9ICdlbCcrKCsrdGhpcy5kZXB0aCk7XG4gIHRoaXMuc291cmNlLnB1c2godGhpcy5pbmRlbnQrJyAgdmFyICcrZWwrJyA9IGRvbS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XFxuJyk7XG59O1xuXG5GcmFnbWVudEphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uKHRhZ05hbWUpIHtcbiAgdmFyIGVsID0gJ2VsJysoKyt0aGlzLmRlcHRoKTtcbiAgaWYgKHRhZ05hbWUgPT09ICdzdmcnKSB7XG4gICAgdGhpcy5wdXNoTmFtZXNwYWNlRnJhbWUoe25hbWVzcGFjZTogc3ZnTmFtZXNwYWNlLCBkZXB0aDogdGhpcy5kZXB0aH0pO1xuICB9XG4gIHRoaXMuZW5zdXJlTmFtZXNwYWNlKCk7XG4gIHRoaXMuc291cmNlLnB1c2godGhpcy5pbmRlbnQrJyAgdmFyICcrZWwrJyA9IGRvbS5jcmVhdGVFbGVtZW50KCcrc3RyaW5nKHRhZ05hbWUpKycpO1xcbicpO1xuICBpZiAoc3ZnSFRNTEludGVncmF0aW9uUG9pbnRzW3RhZ05hbWVdKSB7XG4gICAgdGhpcy5wdXNoTmFtZXNwYWNlRnJhbWUoe25hbWVzcGFjZTogbnVsbCwgZGVwdGg6IHRoaXMuZGVwdGh9KTtcbiAgfVxufTtcblxuRnJhZ21lbnRKYXZhU2NyaXB0Q29tcGlsZXIucHJvdG90eXBlLmNyZWF0ZVRleHQgPSBmdW5jdGlvbihzdHIpIHtcbiAgdmFyIGVsID0gJ2VsJysoKyt0aGlzLmRlcHRoKTtcbiAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmluZGVudCsnICB2YXIgJytlbCsnID0gZG9tLmNyZWF0ZVRleHROb2RlKCcrc3RyaW5nKHN0cikrJyk7XFxuJyk7XG59O1xuXG5GcmFnbWVudEphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUuY3JlYXRlQ29tbWVudCA9IGZ1bmN0aW9uKHN0cikge1xuICB2YXIgZWwgPSAnZWwnKygrK3RoaXMuZGVwdGgpO1xuICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuaW5kZW50KycgIHZhciAnK2VsKycgPSBkb20uY3JlYXRlQ29tbWVudCgnK3N0cmluZyhzdHIpKycpO1xcbicpO1xufTtcblxuRnJhZ21lbnRKYXZhU2NyaXB0Q29tcGlsZXIucHJvdG90eXBlLnJldHVybk5vZGUgPSBmdW5jdGlvbigpIHtcbiAgdmFyIGVsID0gJ2VsJyt0aGlzLmRlcHRoO1xuICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuaW5kZW50KycgIHJldHVybiAnK2VsKyc7XFxuJyk7XG59O1xuXG5GcmFnbWVudEphdmFTY3JpcHRDb21waWxlci5wcm90b3R5cGUuc2V0QXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIG5hbWVzcGFjZSkge1xuICB2YXIgZWwgPSAnZWwnK3RoaXMuZGVwdGg7XG4gIGlmIChuYW1lc3BhY2UpIHtcbiAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuaW5kZW50KycgIGRvbS5zZXRBdHRyaWJ1dGVOUygnK2VsKycsJytzdHJpbmcobmFtZXNwYWNlKSsnLCcrc3RyaW5nKG5hbWUpKycsJytzdHJpbmcodmFsdWUpKycpO1xcbicpO1xuICB9IGVsc2Uge1xuICAgIHRoaXMuc291cmNlLnB1c2godGhpcy5pbmRlbnQrJyAgZG9tLnNldEF0dHJpYnV0ZSgnK2VsKycsJytzdHJpbmcobmFtZSkrJywnK3N0cmluZyh2YWx1ZSkrJyk7XFxuJyk7XG4gIH1cbn07XG5cbkZyYWdtZW50SmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZS5hcHBlbmRDaGlsZCA9IGZ1bmN0aW9uKCkge1xuICBpZiAodGhpcy5kZXB0aCA9PT0gdGhpcy5nZXRDdXJyZW50TmFtZXNwYWNlRnJhbWUoKS5kZXB0aCkge1xuICAgIHRoaXMucG9wTmFtZXNwYWNlRnJhbWUoKTtcbiAgfVxuICB2YXIgY2hpbGQgPSAnZWwnKyh0aGlzLmRlcHRoLS0pO1xuICB2YXIgZWwgPSAnZWwnK3RoaXMuZGVwdGg7XG4gIHRoaXMuc291cmNlLnB1c2godGhpcy5pbmRlbnQrJyAgZG9tLmFwcGVuZENoaWxkKCcrZWwrJywgJytjaGlsZCsnKTtcXG4nKTtcbn07XG5cbkZyYWdtZW50SmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZS5nZXRDdXJyZW50TmFtZXNwYWNlRnJhbWUgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMubmFtZXNwYWNlRnJhbWVTdGFja1t0aGlzLm5hbWVzcGFjZUZyYW1lU3RhY2subGVuZ3RoLTFdO1xufTtcblxuRnJhZ21lbnRKYXZhU2NyaXB0Q29tcGlsZXIucHJvdG90eXBlLnB1c2hOYW1lc3BhY2VGcmFtZSA9IGZ1bmN0aW9uKGZyYW1lKSB7XG4gIHRoaXMubmFtZXNwYWNlRnJhbWVTdGFjay5wdXNoKGZyYW1lKTtcbn07XG5cbkZyYWdtZW50SmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZS5wb3BOYW1lc3BhY2VGcmFtZSA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gdGhpcy5uYW1lc3BhY2VGcmFtZVN0YWNrLnBvcCgpO1xufTtcblxuRnJhZ21lbnRKYXZhU2NyaXB0Q29tcGlsZXIucHJvdG90eXBlLmVuc3VyZU5hbWVzcGFjZSA9IGZ1bmN0aW9uKCkge1xuICB2YXIgY29ycmVjdE5hbWVzcGFjZSA9IHRoaXMuZ2V0Q3VycmVudE5hbWVzcGFjZUZyYW1lKCkubmFtZXNwYWNlO1xuICBpZiAodGhpcy5kb21OYW1lc3BhY2UgIT09IGNvcnJlY3ROYW1lc3BhY2UpIHtcbiAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuaW5kZW50KycgIGRvbS5zZXROYW1lc3BhY2UoJysoY29ycmVjdE5hbWVzcGFjZSA/IHN0cmluZyhjb3JyZWN0TmFtZXNwYWNlKSA6ICdudWxsJykrJyk7XFxuJyk7XG4gICAgdGhpcy5kb21OYW1lc3BhY2UgPSBjb3JyZWN0TmFtZXNwYWNlO1xuICB9XG59O1xuIl19