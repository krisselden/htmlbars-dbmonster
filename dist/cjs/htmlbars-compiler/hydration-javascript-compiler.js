exports.__esModule = true;

var _utils = require("./utils");

var _htmlbarsUtilQuoting = require("../htmlbars-util/quoting");

function HydrationJavaScriptCompiler() {
  this.stack = [];
  this.source = [];
  this.mustaches = [];
  this.parents = [['fragment']];
  this.parentCount = 0;
  this.morphs = [];
  this.fragmentProcessing = [];
  this.hooks = undefined;
}

exports.default = HydrationJavaScriptCompiler;

var prototype = HydrationJavaScriptCompiler.prototype;

prototype.compile = function (opcodes, options) {
  this.stack.length = 0;
  this.mustaches.length = 0;
  this.source.length = 0;
  this.parents.length = 1;
  this.parents[0] = ['fragment'];
  this.morphs.length = 0;
  this.fragmentProcessing.length = 0;
  this.parentCount = 0;
  this.indent = options && options.indent || "";
  this.hooks = {};
  this.hasOpenBoundary = false;
  this.hasCloseBoundary = false;
  this.statements = [];
  this.expressionStack = [];
  this.locals = [];
  this.hasOpenBoundary = false;
  this.hasCloseBoundary = false;

  _utils.processOpcodes(this, opcodes);

  if (this.hasOpenBoundary) {
    this.source.unshift(this.indent + "  dom.insertBoundary(fragment, 0);\n");
  }

  if (this.hasCloseBoundary) {
    this.source.unshift(this.indent + "  dom.insertBoundary(fragment, null);\n");
  }

  var i, l;

  var indent = this.indent;

  var morphs;

  var result = {
    createMorphsProgram: '',
    hydrateMorphsProgram: '',
    fragmentProcessingProgram: '',
    statements: this.statements,
    locals: this.locals,
    hasMorphs: false
  };

  result.hydrateMorphsProgram = this.source.join('');

  if (this.morphs.length) {
    result.hasMorphs = true;
    morphs = indent + '  var morphs = new Array(' + this.morphs.length + ');\n';

    for (i = 0, l = this.morphs.length; i < l; ++i) {
      var morph = this.morphs[i];
      morphs += indent + '  morphs[' + i + '] = ' + morph + ';\n';
    }
  }

  if (this.fragmentProcessing.length) {
    var processing = "";
    for (i = 0, l = this.fragmentProcessing.length; i < l; ++i) {
      processing += this.indent + '  ' + this.fragmentProcessing[i] + '\n';
    }
    result.fragmentProcessingProgram = processing;
  }

  var createMorphsProgram;
  if (result.hasMorphs) {
    createMorphsProgram = 'function buildRenderNodes(dom, fragment, contextualElement) {\n' + result.fragmentProcessingProgram + morphs;

    if (this.hasOpenBoundary) {
      createMorphsProgram += indent + "  dom.insertBoundary(fragment, 0);\n";
    }

    if (this.hasCloseBoundary) {
      createMorphsProgram += indent + "  dom.insertBoundary(fragment, null);\n";
    }

    createMorphsProgram += indent + '  return morphs;\n' + indent + '}';
  } else {
    createMorphsProgram = 'function buildRenderNodes() { return []; }';
  }

  result.createMorphsProgram = createMorphsProgram;

  return result;
};

prototype.prepareArray = function (length) {
  var values = [];

  for (var i = 0; i < length; i++) {
    values.push(this.expressionStack.pop());
  }

  this.expressionStack.push(values);
};

prototype.prepareObject = function (size) {
  var pairs = [];

  for (var i = 0; i < size; i++) {
    pairs.push(this.expressionStack.pop(), this.expressionStack.pop());
  }

  this.expressionStack.push(pairs);
};

prototype.openBoundary = function () {
  this.hasOpenBoundary = true;
};

prototype.closeBoundary = function () {
  this.hasCloseBoundary = true;
};

prototype.pushLiteral = function (value) {
  this.expressionStack.push(value);
};

prototype.pushGetHook = function (path, meta) {
  this.expressionStack.push(['get', path, meta]);
};

prototype.pushSexprHook = function (meta) {
  this.expressionStack.push(['subexpr', this.expressionStack.pop(), this.expressionStack.pop(), this.expressionStack.pop(), meta]);
};

prototype.pushConcatHook = function () {
  this.expressionStack.push(['concat', this.expressionStack.pop()]);
};

prototype.printSetHook = function (name) {
  this.locals.push(name);
};

prototype.printBlockHook = function (templateId, inverseId, meta) {
  this.statements.push(['block', this.expressionStack.pop(), // path
  this.expressionStack.pop(), // params
  this.expressionStack.pop(), // hash
  templateId, inverseId, meta]);
};

prototype.printInlineHook = function (meta) {
  var path = this.expressionStack.pop();
  var params = this.expressionStack.pop();
  var hash = this.expressionStack.pop();

  this.statements.push(['inline', path, params, hash, meta]);
};

prototype.printContentHook = function (meta) {
  this.statements.push(['content', this.expressionStack.pop(), meta]);
};

prototype.printComponentHook = function (templateId) {
  this.statements.push(['component', this.expressionStack.pop(), // path
  this.expressionStack.pop(), // attrs
  templateId]);
};

prototype.printAttributeHook = function () {
  this.statements.push(['attribute', this.expressionStack.pop(), // name
  this.expressionStack.pop() // value;
  ]);
};

prototype.printElementHook = function (meta) {
  this.statements.push(['element', this.expressionStack.pop(), // path
  this.expressionStack.pop(), // params
  this.expressionStack.pop(), // hash
  meta]);
};

prototype.createMorph = function (morphNum, parentPath, startIndex, endIndex, escaped) {
  var isRoot = parentPath.length === 0;
  var parent = this.getParent();

  var morphMethod = escaped ? 'createMorphAt' : 'createUnsafeMorphAt';
  var morph = "dom." + morphMethod + "(" + parent + "," + (startIndex === null ? "-1" : startIndex) + "," + (endIndex === null ? "-1" : endIndex) + (isRoot ? ",contextualElement)" : ")");

  this.morphs[morphNum] = morph;
};

prototype.createAttrMorph = function (attrMorphNum, elementNum, name, escaped, namespace) {
  var morphMethod = escaped ? 'createAttrMorph' : 'createUnsafeAttrMorph';
  var morph = "dom." + morphMethod + "(element" + elementNum + ", '" + name + (namespace ? "', '" + namespace : '') + "')";
  this.morphs[attrMorphNum] = morph;
};

prototype.createElementMorph = function (morphNum, elementNum) {
  var morphMethod = 'createElementMorph';
  var morph = "dom." + morphMethod + "(element" + elementNum + ")";
  this.morphs[morphNum] = morph;
};

prototype.repairClonedNode = function (blankChildTextNodes, isElementChecked) {
  var parent = this.getParent(),
      processing = 'if (this.cachedFragment) { dom.repairClonedNode(' + parent + ',' + _htmlbarsUtilQuoting.array(blankChildTextNodes) + (isElementChecked ? ',true' : '') + '); }';
  this.fragmentProcessing.push(processing);
};

prototype.shareElement = function (elementNum) {
  var elementNodesName = "element" + elementNum;
  this.fragmentProcessing.push('var ' + elementNodesName + ' = ' + this.getParent() + ';');
  this.parents[this.parents.length - 1] = [elementNodesName];
};

prototype.consumeParent = function (i) {
  var newParent = this.lastParent().slice();
  newParent.push(i);

  this.parents.push(newParent);
};

prototype.popParent = function () {
  this.parents.pop();
};

prototype.getParent = function () {
  var last = this.lastParent().slice();
  var frag = last.shift();

  if (!last.length) {
    return frag;
  }

  return 'dom.childAt(' + frag + ', [' + last.join(', ') + '])';
};

prototype.lastParent = function () {
  return this.parents[this.parents.length - 1];
};
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLWNvbXBpbGVyL2h5ZHJhdGlvbi1qYXZhc2NyaXB0LWNvbXBpbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O3FCQUErQixTQUFTOzttQ0FDbEIsMEJBQTBCOztBQUVoRCxTQUFTLDJCQUEyQixHQUFHO0FBQ3JDLE1BQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBQ2hCLE1BQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ2pCLE1BQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLE1BQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDOUIsTUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDckIsTUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDakIsTUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztBQUM3QixNQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQztDQUN4Qjs7a0JBRWMsMkJBQTJCOztBQUUxQyxJQUFJLFNBQVMsR0FBRywyQkFBMkIsQ0FBQyxTQUFTLENBQUM7O0FBRXRELFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBUyxPQUFPLEVBQUUsT0FBTyxFQUFFO0FBQzdDLE1BQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUN0QixNQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFDMUIsTUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUN4QixNQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDL0IsTUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQUksQ0FBQyxrQkFBa0IsQ0FBQyxN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QUFPLElBQUksQ0FBQztHQUNiOztBQUVELFNBQU8sY0FBYyxHQUFHLElBQUksR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7Q0FDL0QsQ0FBQzs7QUFFRixTQUFTLENBQUMsVUFBVSxHQUFHLFlBQVc7QUFDaEMsU0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFDLENBQUMsQ0FBQyxDQUFDO0NBQzVDLENBQUMiLCJmaWxlIjoiaHRtbGJhcnMtY29tcGlsZXIvaHlkcmF0aW9uLWphdmFzY3JpcHQtY29tcGlsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwcm9jZXNzT3Bjb2RlcyB9IGZyb20gXCIuL3V0aWxzXCI7XG5pbXBvcnQgeyBhcnJheSB9IGZyb20gXCIuLi9odG1sYmFycy11dGlsL3F1b3RpbmdcIjtcblxuZnVuY3Rpb24gSHlkcmF0aW9uSmF2YVNjcmlwdENvbXBpbGVyKCkge1xuICB0aGlzLnN0YWNrID0gW107XG4gIHRoaXMuc291cmNlID0gW107XG4gIHRoaXMubXVzdGFjaGVzID0gW107XG4gIHRoaXMucGFyZW50cyA9IFtbJ2ZyYWdtZW50J11dO1xuICB0aGlzLnBhcmVudENvdW50ID0gMDtcbiAgdGhpcy5tb3JwaHMgPSBbXTtcbiAgdGhpcy5mcmFnbWVudFByb2Nlc3NpbmcgPSBbXTtcbiAgdGhpcy5ob29rcyA9IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgSHlkcmF0aW9uSmF2YVNjcmlwdENvbXBpbGVyO1xuXG52YXIgcHJvdG90eXBlID0gSHlkcmF0aW9uSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZTtcblxucHJvdG90eXBlLmNvbXBpbGUgPSBmdW5jdGlvbihvcGNvZGVzLCBvcHRpb25zKSB7XG4gIHRoaXMuc3RhY2subGVuZ3RoID0gMDtcbiAgdGhpcy5tdXN0YWNoZXMubGVuZ3RoID0gMDtcbiAgdGhpcy5zb3VyY2UubGVuZ3RoID0gMDtcbiAgdGhpcy5wYXJlbnRzLmxlbmd0aCA9IDE7XG4gIHRoaXMucGFyZW50c1swXSA9IFsnZnJhZ21lbnQnXTtcbiAgdGhpcy5tb3JwaHMubGVuZ3RoID0gMDtcbiAgdGhpcy5mcmFnbWVudFByb2Nlc3NpbmcubGVuZ3RoID0gMDtcbiAgdGhpcy5wYXJlbnRDb3VudCA9IDA7XG4gIHRoaXMuaW5kZW50ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5pbmRlbnQpIHx8IFwiXCI7XG4gIHRoaXMuaG9va3MgPSB7fTtcbiAgdGhpcy5oYXNPcGVuQm91bmRhcnkgPSBmYWxzZTtcbiAgdGhpcy5oYXNDbG9zZUJvdW5kYXJ5ID0gZmFsc2U7XG4gIHRoaXMuc3RhdGVtZW50cyA9IFtdO1xuICB0aGlzLmV4cHJlc3Npb25TdGFjayA9IFtdO1xuICB0aGlzLmxvY2FscyA9IFtdO1xuICB0aGlzLmhhc09wZW5Cb3VuZGFyeSA9IGZhbHNlO1xuICB0aGlzLmhhc0Nsb3NlQm91bmRhcnkgPSBmYWxzZTtcblxuICBwcm9jZXNzT3Bjb2Rlcyh0aGlzLCBvcGNvZGVzKTtcblxuICBpZiAodGhpcy5oYXNPcGVuQm91bmRhcnkpIHtcbiAgICB0aGlzLnNvdXJjZS51bnNoaWZ0KHRoaXMuaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIDApO1xcblwiKTtcbiAgfVxuXG4gIGlmICh0aGlzLmhhc0Nsb3NlQm91bmRhcnkpIHtcbiAgICB0aGlzLnNvdXJjZS51bnNoaWZ0KHRoaXMuaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIG51bGwpO1xcblwiKTtcbiAgfVxuXG4gIHZhciBpLCBsO1xuXG4gIHZhciBpbmRlbnQgPSB0aGlzLmluZGVudDtcblxuICB2YXIgbW9ycGhzO1xuXG4gIHZhciByZXN1bHQgPSB7XG4gICAgY3JlYXRlTW9ycGhzUHJvZ3JhbTogJycsXG4gICAgaHlkcmF0ZU1vcnBoc1Byb2dyYW06ICcnLFxuICAgIGZyYWdtZW50UHJvY2Vzc2luZ1Byb2dyYW06ICcnLFxuICAgIHN0YXRlbWVudHM6IHRoaXMuc3RhdGVtZW50cyxcbiAgICBsb2NhbHM6IHRoaXMubG9jYWxzLFxuICAgIGhhc01vcnBoczogZmFsc2VcbiAgfTtcblxuICByZXN1bHQuaHlkcmF0ZU1vcnBoc1Byb2dyYW0gPSB0aGlzLnNvdXJjZS5qb2luKCcnKTtcblxuICBpZiAodGhpcy5tb3JwaHMubGVuZ3RoKSB7XG4gICAgcmVzdWx0Lmhhc01vcnBocyA9IHRydWU7XG4gICAgbW9ycGhzID1cbiAgICAgIGluZGVudCsnICB2YXIgbW9ycGhzID0gbmV3IEFycmF5KCcgKyB0aGlzLm1vcnBocy5sZW5ndGggKyAnKTtcXG4nO1xuXG4gICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5tb3JwaHMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICAgIHZhciBtb3JwaCA9IHRoaXMubW9ycGhzW2ldO1xuICAgICAgICBtb3JwaHMgKz0gaW5kZW50KycgIG1vcnBoc1snK2krJ10gPSAnK21vcnBoKyc7XFxuJztcbiAgICAgIH1cbiAgfVxuXG4gIGlmICh0aGlzLmZyYWdtZW50UHJvY2Vzc2luZy5sZW5ndGgpIHtcbiAgICB2YXIgcHJvY2Vzc2luZyA9IFwiXCI7XG4gICAgZm9yIChpID0gMCwgbCA9IHRoaXMuZnJhZ21lbnRQcm9jZXNzaW5nLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgcHJvY2Vzc2luZyArPSB0aGlzLmluZGVudCsnICAnK3RoaXMuZnJhZ21lbnRQcm9jZXNzaW5nW2ldKydcXG4nO1xuICAgIH1cbiAgICByZXN1bHQuZnJhZ21lbnRQcm9jZXNzaW5nUHJvZ3JhbSA9IHByb2Nlc3Npbmc7XG4gIH1cblxuICB2YXIgY3JlYXRlTW9ycGhzUHJvZ3JhbTtcbiAgaWYgKHJlc3VsdC5oYXNNb3JwaHMpIHtcbiAgICBjcmVhdGVNb3JwaHNQcm9ncmFtID1cbiAgICAgICdmdW5jdGlvbiBidWlsZFJlbmRlck5vZGVzKGRvbSwgZnJhZ21lbnQsIGNvbnRleHR1YWxFbGVtZW50KSB7XFxuJyArXG4gICAgICByZXN1bHQuZnJhZ21lbnRQcm9jZXNzaW5nUHJvZ3JhbSArIG1vcnBocztcblxuICAgICAgaWYgKHRoaXMuaGFzT3BlbkJvdW5kYXJ5KSB7XG4gICAgICAgIGNyZWF0ZU1vcnBoc1Byb2dyYW0gKz0gaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIDApO1xcblwiO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5oYXNDbG9zZUJvdW5kYXJ5KSB7XG4gICAgICAgIGNyZWF0ZU1vcnBoc1Byb2dyYW0gKz0gaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIG51bGwpO1xcblwiO1xuICAgICAgfVxuXG4gICAgICBjcmVhdGVNb3JwaHNQcm9ncmFtICs9XG4gICAgICBpbmRlbnQgKyAnICByZXR1cm4gbW9ycGhzO1xcbicgK1xuICAgICAgaW5kZW50Kyd9JztcbiAgfSBlbHNlIHtcbiAgICBjcmVhdGVNb3JwaHNQcm9ncmFtID1cbiAgICAgICdmdW5jdGlvbiBidWlsZFJlbmRlck5vZGVzKCkgeyByZXR1cm4gW107IH0nO1xuICB9XG5cbiAgcmVzdWx0LmNyZWF0ZU1vcnBoc1Byb2dyYW0gPSBjcmVhdGVNb3JwaHNQcm9ncmFtO1xuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5wcm90b3R5cGUucHJlcGFyZUFycmF5ID0gZnVuY3Rpb24obGVuZ3RoKSB7XG4gIHZhciB2YWx1ZXMgPSBbXTtcblxuICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgdmFsdWVzLnB1c2godGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCkpO1xuICB9XG5cbiAgdGhpcy5leHByZXNzaW9uU3RhY2sucHVzaCh2YWx1ZXMpO1xufTtcblxucHJvdG90eXBlLnByZXBhcmVPYmplY3QgPSBmdW5jdGlvbihzaXplKSB7XG4gIHZhciBwYWlycyA9IFtdO1xuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7XG4gICAgcGFpcnMucHVzaCh0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCkpO1xuICB9XG5cbiAgdGhpcy5leHByZXNzaW9uU3RhY2sucHVzaChwYWlycyk7XG59O1xuXG5wcm90b3R5cGUub3BlbkJvdW5kYXJ5ID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuaGFzT3BlbkJvdW5kYXJ5ID0gdHJ1ZTtcbn07XG5cbnByb3RvdHlwZS5jbG9zZUJvdW5kYXJ5ID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuaGFzQ2xvc2VCb3VuZGFyeSA9IHRydWU7XG59O1xuXG5wcm90b3R5cGUucHVzaExpdGVyYWwgPSBmdW5jdGlvbih2YWx1ZSkge1xuICB0aGlzLmV4cHJlc3Npb25TdGFjay5wdXNoKHZhbHVlKTtcbn07XG5cbnByb3RvdHlwZS5wdXNoR2V0SG9vayA9IGZ1bmN0aW9uKHBhdGgsIG1ldGEpIHtcbiAgdGhpcy5leHByZXNzaW9uU3RhY2sucHVzaChbICdnZXQnLCBwYXRoLCBtZXRhIF0pO1xufTtcblxucHJvdG90eXBlLnB1c2hTZXhwckhvb2sgPSBmdW5jdGlvbihtZXRhKSB7XG4gIHRoaXMuZXhwcmVzc2lvblN0YWNrLnB1c2goW1xuICAgICdzdWJleHByJyxcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSxcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSxcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSxcbiAgICBtZXRhXG4gIF0pO1xufTtcblxucHJvdG90eXBlLnB1c2hDb25jYXRIb29rID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuZXhwcmVzc2lvblN0YWNrLnB1c2goWyAnY29uY2F0JywgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCkgXSk7XG59O1xuXG5wcm90b3R5cGUucHJpbnRTZXRIb29rID0gZnVuY3Rpb24obmFtZSkge1xuICB0aGlzLmxvY2Fscy5wdXNoKG5hbWUpO1xufTtcblxucHJvdG90eXBlLnByaW50QmxvY2tIb29rID0gZnVuY3Rpb24odGVtcGxhdGVJZCwgaW52ZXJzZUlkLCBtZXRhKSB7XG4gIHRoaXMuc3RhdGVtZW50cy5wdXNoKFtcbiAgICAnYmxvY2snLFxuICAgIHRoaXMuZXhwcmVzc2lvblN0YWNrLnBvcCgpLCAvLyBwYXRoXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksIC8vIHBhcmFtc1xuICAgIHRoaXMuZXhwcmVzc2lvblN0YWNrLnBvcCgpLCAvLyBoYXNoXG4gICAgdGVtcGxhdGVJZCxcbiAgICBpbnZlcnNlSWQsXG4gICAgbWV0YVxuICBdKTtcbn07XG5cbnByb3RvdHlwZS5wcmludElubGluZUhvb2sgPSBmdW5jdGlvbihtZXRhKSB7XG4gIHZhciBwYXRoID0gdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCk7XG4gIHZhciBwYXJhbXMgPSB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKTtcbiAgdmFyIGhhc2ggPSB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKTtcblxuICB0aGlzLnN0YXRlbWVudHMucHVzaChbICdpbmxpbmUnLCBwYXRoLCBwYXJhbXMsIGhhc2gsIG1ldGEgXSk7XG59O1xuXG5wcm90b3R5cGUucHJpbnRDb250ZW50SG9vayA9IGZ1bmN0aW9uKG1ldGEpIHtcbiAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goWyAnY29udGVudCcsIHRoaXMuZXhwcmVzc2lvblN0YWNrLnBvcCgpLCBtZXRhXSk7XG59O1xuXG5wcm90b3R5cGUucHJpbnRDb21wb25lbnRIb29rID0gZnVuY3Rpb24odGVtcGxhdGVJZCkge1xuICB0aGlzLnN0YXRlbWVudHMucHVzaChbXG4gICAgJ2NvbXBvbmVudCcsXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksIC8vIHBhdGhcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgLy8gYXR0cnNcbiAgICB0ZW1wbGF0ZUlkXG4gIF0pO1xufTtcblxucHJvdG90eXBlLnByaW50QXR0cmlidXRlSG9vayA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLnN0YXRlbWVudHMucHVzaChbXG4gICAgJ2F0dHJpYnV0ZScsXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksIC8vIG5hbWVcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSAgLy8gdmFsdWU7XG4gIF0pO1xufTtcblxucHJvdG90eXBlLnByaW50RWxlbWVudEhvb2sgPSBmdW5jdGlvbihtZXRhKSB7XG4gIHRoaXMuc3RhdGVtZW50cy5wdXNoKFtcbiAgICAnZWxlbWVudCcsXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksIC8vIHBhdGhcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgLy8gcGFyYW1zXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksIC8vIGhhc2hcbiAgICBtZXRhXG4gIF0pO1xufTtcblxucHJvdG90eXBlLmNyZWF0ZU1vcnBoID0gZnVuY3Rpb24obW9ycGhOdW0sIHBhcmVudFBhdGgsIHN0YXJ0SW5kZXgsIGVuZEluZGV4LCBlc2NhcGVkKSB7XG4gIHZhciBpc1Jvb3QgPSBwYXJlbnRQYXRoLmxlbmd0aCA9PT0gMDtcbiAgdmFyIHBhcmVudCA9IHRoaXMuZ2V0UGFyZW50KCk7XG5cbiAgdmFyIG1vcnBoTWV0aG9kID0gZXNjYXBlZCA/ICdjcmVhdGVNb3JwaEF0JyA6ICdjcmVhdGVVbnNhZmVNb3JwaEF0JztcbiAgdmFyIG1vcnBoID0gXCJkb20uXCIrbW9ycGhNZXRob2QrXCIoXCIrcGFyZW50K1xuICAgIFwiLFwiKyhzdGFydEluZGV4ID09PSBudWxsID8gXCItMVwiIDogc3RhcnRJbmRleCkrXG4gICAgXCIsXCIrKGVuZEluZGV4ID09PSBudWxsID8gXCItMVwiIDogZW5kSW5kZXgpK1xuICAgIChpc1Jvb3QgPyBcIixjb250ZXh0dWFsRWxlbWVudClcIiA6IFwiKVwiKTtcblxuICB0aGlzLm1vcnBoc1ttb3JwaE51bV0gPSBtb3JwaDtcbn07XG5cbnByb3RvdHlwZS5jcmVhdGVBdHRyTW9ycGggPSBmdW5jdGlvbihhdHRyTW9ycGhOdW0sIGVsZW1lbnROdW0sIG5hbWUsIGVzY2FwZWQsIG5hbWVzcGFjZSkge1xuICB2YXIgbW9ycGhNZXRob2QgPSBlc2NhcGVkID8gJ2NyZWF0ZUF0dHJNb3JwaCcgOiAnY3JlYXRlVW5zYWZlQXR0ck1vcnBoJztcbiAgdmFyIG1vcnBoID0gXCJkb20uXCIrbW9ycGhNZXRob2QrXCIoZWxlbWVudFwiK2VsZW1lbnROdW0rXCIsICdcIituYW1lKyhuYW1lc3BhY2UgPyBcIicsICdcIituYW1lc3BhY2UgOiAnJykrXCInKVwiO1xuICB0aGlzLm1vcnBoc1thdHRyTW9ycGhOdW1dID0gbW9ycGg7XG59O1xuXG5wcm90b3R5cGUuY3JlYXRlRWxlbWVudE1vcnBoID0gZnVuY3Rpb24obW9ycGhOdW0sIGVsZW1lbnROdW0gKSB7XG4gIHZhciBtb3JwaE1ldGhvZCA9ICdjcmVhdGVFbGVtZW50TW9ycGgnO1xuICB2YXIgbW9ycGggPSBcImRvbS5cIittb3JwaE1ldGhvZCtcIihlbGVtZW50XCIrZWxlbWVudE51bStcIilcIjtcbiAgdGhpcy5tb3JwaHNbbW9ycGhOdW1dID0gbW9ycGg7XG59O1xuXG5wcm90b3R5cGUucmVwYWlyQ2xvbmVkTm9kZSA9IGZ1bmN0aW9uKGJsYW5rQ2hpbGRUZXh0Tm9kZXMsIGlzRWxlbWVudENoZWNrZWQpIHtcbiAgdmFyIHBhcmVudCA9IHRoaXMuZ2V0UGFyZW50KCksXG4gICAgICBwcm9jZXNzaW5nID0gJ2lmICh0aGlzLmNhY2hlZEZyYWdtZW50KSB7IGRvbS5yZXBhaXJDbG9uZWROb2RlKCcrcGFyZW50KycsJytcbiAgICAgICAgICAgICAgICAgICBhcnJheShibGFua0NoaWxkVGV4dE5vZGVzKStcbiAgICAgICAgICAgICAgICAgICAoIGlzRWxlbWVudENoZWNrZWQgPyAnLHRydWUnIDogJycgKStcbiAgICAgICAgICAgICAgICAgICAnKTsgfSc7XG4gIHRoaXMuZnJhZ21lbnRQcm9jZXNzaW5nLnB1c2goXG4gICAgcHJvY2Vzc2luZ1xuICApO1xufTtcblxucHJvdG90eXBlLnNoYXJlRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnROdW0pe1xuICB2YXIgZWxlbWVudE5vZGVzTmFtZSA9IFwiZWxlbWVudFwiICsgZWxlbWVudE51bTtcbiAgdGhpcy5mcmFnbWVudFByb2Nlc3NpbmcucHVzaCgndmFyICcrZWxlbWVudE5vZGVzTmFtZSsnID0gJyt0aGlzLmdldFBhcmVudCgpKyc7Jyk7XG4gIHRoaXMucGFyZW50c1t0aGlzLnBhcmVudHMubGVuZ3RoLTFdID0gW2VsZW1lbnROb2Rlc05hbWVdO1xufTtcblxucHJvdG90eXBlLmNvbnN1bWVQYXJlbnQgPSBmdW5jdGlvbihpKSB7XG4gIHZhciBuZXdQYXJlbnQgPSB0aGlzLmxhc3RQYXJlbnQoKS5zbGljZSgpO1xuICBuZXdQYXJlbnQucHVzaChpKTtcblxuICB0aGlzLnBhcmVudHMucHVzaChuZXdQYXJlbnQpO1xufTtcblxucHJvdG90eXBlLnBvcFBhcmVudCA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLnBhcmVudHMucG9wKCk7XG59O1xuXG5wcm90b3R5cGUuZ2V0UGFyZW50ID0gZnVuY3Rpb24oKSB7XG4gIHZhciBsYXN0ID0gdGhpcy5sYXN0UGFyZW50KCkuc2xpY2UoKTtcbiAgdmFyIGZyYWcgPSBsYXN0LnNoaWZ0KCk7XG5cbiAgaWYgKCFsYXN0Lmxlbmd0aCkge1xuICAgIHJldHVybiBmcmFnO1xuICB9XG5cbiAgcmV0dXJuICdkb20uY2hpbGRBdCgnICsgZnJhZyArICcsIFsnICsgbGFzdC5qb2luKCcsICcpICsgJ10pJztcbn07XG5cbnByb3RvdHlwZS5sYXN0UGFyZW50ID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiB0aGlzLnBhcmVudHNbdGhpcy5wYXJlbnRzLmxlbmd0aC0xXTtcbn07XG4iXX0=